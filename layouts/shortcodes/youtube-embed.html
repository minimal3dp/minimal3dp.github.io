{{/* Usage: {{< youtube-embed id="VIDEO_ID" title="Video Title" >}} */}}

{{ $id := .Get "id" }}
{{ $title := .Get "title" | default "YouTube Video" }}
{{ $channelId := .Site.Params.youtube_channel_id }}

{{- /* Fetch and process YouTube thumbnail to WebP */ -}}
{{- $thumbUrl := printf "https://i.ytimg.com/vi/%s/maxresdefault.jpg" $id -}}
{{- $remoteImg := resources.GetRemote $thumbUrl -}}
{{- $webp := "" -}}
{{- $lqipData := "" -}}
{{- if $remoteImg -}}
  {{- $webp = $remoteImg.Process "fit 1280x720 webp" -}}
  {{- $lqip := $remoteImg.Process "resize 32x webp" -}}
  {{- $lqipData = printf "data:%s;base64,%s" $lqip.MediaType (base64Encode $lqip.Content) -}}
{{- end -}}

<div class="youtube-wrapper" id="yt-{{ $id }}" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin: 30px 0; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); background: #000;">
  {{- if $webp -}}
    {{- /* Show WebP thumbnail with play button, load iframe on click */ -}}
    <div class="yt-thumbnail-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;" onclick="loadYouTubeIframe('{{ $id }}', '{{ $title }}')">
      <img src="{{ $webp.RelPermalink }}"
           alt="{{ $title }}"
           style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"
           class="is-blurred"
           width="{{ $webp.Width }}" height="{{ $webp.Height }}"
           loading="lazy"
           {{- if $lqipData }}data-lqip="{{ $lqipData }}"{{ end }}
           onload="this.classList.remove('is-blurred')">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 68px; height: 48px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
        <svg height="100%" version="1.1" viewBox="0 0 68 48" width="100%"><path d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z" fill="#f00"></path><path d="M 45,24 27,14 27,34" fill="#fff"></path></svg>
      </div>
    </div>
  {{- else -}}
    {{- /* Fallback: direct iframe embed */ -}}
    <iframe 
      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
      src="https://www.youtube-nocookie.com/embed/{{ $id }}?rel=0&modestbranding=1" 
      title="{{ $title }}"
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen
      loading="lazy">
    </iframe>
  {{- end -}}
</div>

<script>
function loadYouTubeIframe(videoId, title) {
  const wrapper = document.getElementById('yt-' + videoId);
  const iframe = document.createElement('iframe');
  iframe.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%;';
  iframe.src = 'https://www.youtube-nocookie.com/embed/' + videoId + '?rel=0&modestbranding=1&autoplay=1';
  iframe.title = title;
  iframe.frameBorder = '0';
  iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
  iframe.allowFullscreen = true;
  wrapper.innerHTML = '';
  wrapper.appendChild(iframe);
}
</script>

{{ if $channelId }}
<div class="youtube-cta" style="text-align: center; margin: 15px 0;">
  <a href="https://www.youtube.com/channel/{{ $channelId }}?sub_confirmation=1" 
     target="_blank"
     rel="noopener"
     onclick="trackYouTubeSubscribe('{{ $title }}')"
     style="display: inline-block; background: #FF0000; color: #fff; padding: 10px 20px; text-decoration: none; border-radius: 4px; font-weight: bold;">
    ▶️ Subscribe on YouTube
  </a>
</div>

<script>
function trackYouTubeSubscribe(source) {
  if (typeof gtag === 'function') {
    gtag('event', 'subscribe_click', {
      'event_category': 'YouTube',
      'event_label': source
    });
  }
}
</script>
{{ end }}
