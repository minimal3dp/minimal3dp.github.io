---
title: 3D Print Cost Calculator
menu: { main: { weight: 50 } }
---

<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3DP FDM 3D Print Cost Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Light gray background */
        }

        /* Custom tooltip style */
        .info-icon {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            background-color: #9ca3af;
            /* gray-400 */
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 0.75rem;
            line-height: 1rem;
            font-weight: bold;
            font-style: normal;
            cursor: help;
            margin-left: 4px;
            position: relative;
        }

        /* Tooltip text - hidden by default */
        .info-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            /* Position above the icon */
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            /* gray-800 */
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.25;
            white-space: normal;
            width: 320px;
            /* Fixed width for better readability */
            text-align: left;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
        }

        /* Show tooltip on hover */
        .info-icon:hover::after {
            visibility: visible;
            opacity: 1;
        }

        /* Custom style for the sticky summary box */
        .sticky-summary {
            position: sticky;
            top: 1.5rem;
            /* 24px */
            align-self: start;
            /* Prevents stretching to grid height */
        }

        /* Style for the material info boxes */
        .material-info {
            background-color: #f9fafb;
            /* gray-50 */
            border: 1px solid #e5e7eb;
            /* gray-200 */
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        /* Pie Chart */
        #pie-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            /* Conic gradient will be set by JS */
            background-image: conic-gradient(#3b82f6 0% 0%,
                    /* Material (Blue) */
                    #10b981 0% 0%,
                    /* Labor (Green) */
                    #f59e0b 0% 0%,
                    /* Machine (Amber) */
                    #ef4444 0% 0%,
                    /* Tooling (Red) */
                    #8b5cf6 0% 0%
                    /* Finishing (Violet) */
                );
            border: 2px solid #e5e7eb;
        }

        /* Quote Modal */
        #quote-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Print styles for Quote Modal */
        @media print {
            body * {
                visibility: hidden;
            }

            #quote-modal-content,
            #quote-modal-content * {
                visibility: visible;
            }

            #quote-modal-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
            }

            #quote-modal-header,
            #quote-modal-footer {
                display: none;
            }

            body {
                background-color: #ffffff;
            }
        }

        /* Collapsible reference sections */
        details summary {
            cursor: pointer;
            font-weight: 500;
            color: #1f2937;
            /* gray-800 */
            padding: 8px;
            background-color: #f9fafb;
            /* gray-50 */
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        details summary:hover {
            background-color: #f3f4f6;
            /* gray-100 */
        }

        details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        details>div {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            /* gray-200 */
            border-top: none;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }
    </style>
</head>

<body class="h-full bg-gray-100 p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto max-w-7xl">

        <!-- Header -->
        <header class="mb-6">
            <br />
            <br />
            <br />
            <br />

            <h1 class="text-3xl font-bold text-gray-900">
                <a href="https://minimal3dp.com" target="_blank" rel="noopener noreferrer"
                    class="text-blue-600 hover:underline">
                    M3DP FDM 3D Print Cost Calculator
                </a>
            </h1>
            <p class="mt-1 text-lg text-gray-600">A comprehensive tool based on the Seregi & Ficzere (2025) cost model,
                expanded for business and hobbyist quoting.</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Column 1: Input Forms -->
            <div class="flex flex-col gap-6">

                <!-- Save/Load Profile -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="save_profile"
                            class="flex-1 bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Save Printer Profile
                        </button>
                        <button id="load_profile"
                            class="flex-1 bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            Load Printer Profile
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center">Saves/Loads all machine, tooling, power, and
                        markup settings. Job-specific parameters are not saved.</p>
                </div>

                <!-- Card 1: Job Parameters -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">1. Job Parameters</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Quote Details -->
                        <div>
                            <label for="quote_customer" class="block text-sm font-medium text-gray-700">
                                Customer Name (Optional)
                            </label>
                            <input type="text" id="quote_customer" placeholder="e.g., Jane Doe"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="quote_part_name" class="block text-sm font-medium text-gray-700">
                                Part/Project Name (Optional)
                            </label>
                            <input type="text" id="quote_part_name" placeholder="e.g., Enclosure V3"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                        <div class="sm:col-span-2 border-t pt-4"></div>

                        <!-- Print Job Details -->
                        <div>
                            <label for="parts_per_program" class="block text-sm font-medium text-gray-700">
                                Parts Per Build Plate
                                <span class="info-icon"
                                    data-tooltip="The total number of identical parts printed on a single build plate.">i</span>
                            </label>
                            <input type="number" id="parts_per_program" value="1" min="1" step="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="program_length_hr" class="block text-sm font-medium text-gray-700">
                                Total Print Time (Hours)
                                <span class="info-icon"
                                    data-tooltip="Total print job duration, in hours. From your slicer's estimate. (e.g., 4.5 for 4h 30m)">i</span>
                            </label>
                            <input type="number" id="program_length_hr" value="1" min="0" step="0.1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="model_material_g" class="block text-sm font-medium text-gray-700">
                                Model Material (grams)
                                <span class="info-icon"
                                    data-tooltip="Total mass of the main model material used, in grams. From your slicer.">i</span>
                            </label>
                            <input type="number" id="model_material_g" value="10" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="support_material_g" class="block text-sm font-medium text-gray-700">
                                Support Material (grams)
                                <span class="info-icon"
                                    data-tooltip="Total mass of support material used, in grams. From your slicer. Enter 0 if no support is used.">i</span>
                            </label>
                            <input type="number" id="support_material_g" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="failure_rate" class="block text-sm font-medium text-gray-700">
                                Est. Failure Rate (%)
                                <span class="info-icon"
                                    data-tooltip="Amortizes the cost of failed prints across successful ones. A 5% rate means you expect 1 in 20 prints to fail, increasing the cost.">i</span>
                            </label>
                            <input type="number" id="failure_rate" value="5" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 2: Material & Labor -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">2. Material & Labor</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                        <!-- Model Material -->
                        <div>
                            <label for="model_material_cost_kg" class="block text-sm font-medium text-gray-700">
                                Model Material Cost ($/kg)
                                <span class="info-icon"
                                    data-tooltip="The price you paid for a 1kg roll of your model filament. (e.g., 20)">i</span>
                            </label>
                            <input type="number" id="model_material_cost_kg" value="20" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="model_material_type" class="block text-sm font-medium text-gray-700">Model
                                Material Type</label>
                            <select id="model_material_type"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <optgroup label="Common">
                                    <option value="1.24">PLA (1.24 g/cm³)</option>
                                    <option value="1.27">PETG (1.27 g/cm³)</option>
                                    <option value="1.04">ABS (1.04 g/cm³)</option>
                                    <option value="1.06">ASA (1.06 g/cm³)</option>
                                </optgroup>
                                <optgroup label="Engineering/Flexible">
                                    <option value="1.20">TPU/TPE (1.20 g/cm³)</option>
                                    <option value="1.08">Nylon (PA) (1.08 g/cm³)</option>
                                    <option value="1.21">Polycarbonate (PC) (1.20 g/cm³)</option>
                                </optgroup>
                                <optgroup label="My Materials" id="model_material_custom_group">
                                    <!-- Custom materials added by JS -->
                                </optgroup>
                                <optgroup label="Other">
                                    <option value="custom">Add New Custom...</option>
                                </optgroup>
                            </select>
                        </div>
                        <div id="model_material_density_custom_wrapper" class="hidden sm:col-span-2">
                            <label for="model_material_density_custom"
                                class="block text-sm font-medium text-gray-700">Custom Model Density (g/cm³)</label>
                            <input type="number" id="model_material_density_custom" value="1.24" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <!-- Model Material Info Box -->
                        <div id="model_material_info" class="material-info sm:col-span-2">
                            <!-- Content dynamically inserted by JS -->
                        </div>

                        <!-- Support Material -->
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="support_material_cost_kg" class="block text-sm font-medium text-gray-700">
                                Support Material Cost ($/kg)
                                <span class="info-icon"
                                    data-tooltip="The price you paid for a 1kg roll of your support filament.">i</span>
                            </label>
                            <input type="number" id="support_material_cost_kg" value="20" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="support_material_type" class="block text-sm font-medium text-gray-700">Support
                                Material Type</label>
                            <select id="support_material_type"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <optgroup label="Soluble">
                                    <option value="1.25">PVA (1.25 g/cm³)</option>
                                    <option value="1.07">HIPS (1.07 g/cm³)</option>
                                </optgroup>
                                <optgroup label="Breakaway">
                                    <option value="1.24">PLA (1.24 g/cm³)</option>
                                    <option value="1.27">PETG (1.27 g/cm³)</option>
                                    <option value="1.04">ABS (1.04 g/cm³)</option>
                                    <option value="1.06">ASA (1.06 g/cm³)</option>
                                </optgroup>
                                <optgroup label="My Materials" id="support_material_custom_group">
                                    <!-- Custom materials added by JS -->
                                </optgroup>
                                <optgroup label="Other">
                                    <option value="custom">Add New Custom...</option>
                                </optgroup>
                            </select>
                        </div>
                        <div id="support_material_density_custom_wrapper" class="hidden sm:col-span-2">
                            <label for="support_material_density_custom"
                                class="block text-sm font-medium text-gray-700">Custom Support Density (g/cm³)</label>
                            <input type="number" id="support_material_density_custom" value="1.24" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <!-- Support Material Info Box -->
                        <div id="support_material_info" class="material-info sm:col-span-2">
                            <!-- Content dynamically inserted by JS -->
                        </div>

                        <!-- Labor -->
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="hourly_wage" class="block text-sm font-medium text-gray-700">
                                Labor Rate ($/hour)
                                <span class="info-icon"
                                    data-tooltip="Your hourly rate for all manual labor (prep, post-processing, finishing).">i</span>
                            </label>
                            <input type="number" id="hourly_wage" value="20" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="prep_slicing_time" class="block text-sm font-medium text-gray-700">
                                Slicing & Prep (min/build plate)
                                <span class="info-icon"
                                    data-tooltip="Time spent *per build plate* on file prep, model orientation, and slicer setup.">i</span>
                            </label>
                            <input type="number" id="prep_slicing_time" value="10" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="manual_labor_time" class="block text-sm font-medium text-gray-700">
                                Machine Setup (min/build plate)
                                <span class="info-icon"
                                    data-tooltip="Time spent *per build plate* on printer setup, part removal, and cleanup. (Eq 6)">i</span>
                            </label>
                            <input type="number" id="manual_labor_time" value="5" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                    </div>
                </div>

                <!-- Card 3: Custom Material Manager -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">3. My Material Library</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-1">
                            <label for="custom_material_name" class="block text-sm font-medium text-gray-700">Material
                                Name</label>
                            <input type="text" id="custom_material_name" placeholder="e.g., My CF-PC"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="sm:col-span-1">
                            <label for="custom_material_density" class="block text-sm font-medium text-gray-700">Density
                                (g/cm³)</label>
                            <input type="number" id="custom_material_density" placeholder="e.g., 1.28" min="0"
                                step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="sm:col-span-1 flex items-end">
                            <button id="save_custom_material"
                                class="w-full bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                Save Material
                            </button>
                        </div>
                    </div>
                    <div id="custom_material_list" class="mt-4 text-sm text-gray-600 space-y-1">
                        <!-- Saved materials will be listed here by JS -->
                    </div>
                </div>

                <!-- Card 4: Machine Operation -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">4. Machine Operation</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="printer_cost" class="block text-sm font-medium text-gray-700">
                                Printer Cost ($)
                                <span class="info-icon"
                                    data-tooltip="The total purchase price of your 3D printer. (e.g., Hobbyist: $200-$1,000; Professional: $3,000-$10,000+). Used for depreciation.">i</span>
                            </label>
                            <input type="number" id="printer_cost" value="1000"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="printer_lifespan_hr" class="block text-sm font-medium text-gray-700">
                                Printer Lifespan (hours)
                                <span class="info-icon"
                                    data-tooltip="Estimated total operational hours before the printer is fully depreciated (e.g., 20,000 hours).">i</span>
                            </label>
                            <input type="number" id="printer_lifespan_hr" value="20000" min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="maintenance_cost_hr" class="block text-sm font-medium text-gray-700">
                                Maintenance Cost ($/hour)
                                <span class="info-icon"
                                    data-tooltip="Cost of maintenance parts (belts, fans, etc.) amortized per hour. (e.g., $0.05 - $0.25). Hobbyist annual cost ($100-$200) / annual print hours.">i</span>
                            </label>
                            <input type="number" id="maintenance_cost_hr" value="0.10" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="machine_power_w" class="block text-sm font-medium text-gray-700">
                                Avg. Power (Watts)
                                <span class="info-icon"
                                    data-tooltip="Average power consumption of the printer in Watts. (e.g., Ender 3: ~120-150W, Prusa MK3: ~100-130W).">i</span>
                            </label>
                            <input type="number" id="machine_power_w" value="130" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="electricity_cost_kwh" class="block text-sm font-medium text-gray-700">
                                Electricity Cost ($/kWh)
                                <span class="info-icon"
                                    data-tooltip="Your local electricity rate in dollars per kilowatt-hour. (e.g., $0.15)">i</span>
                            </label>
                            <input type="number" id="electricity_cost_kwh" value="0.15" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 5: Tooling -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">5. Tooling (Eq 5)</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Build Plate -->
                        <div>
                            <label for="build_plate_cost" class="block text-sm font-medium text-gray-700">
                                Build Plate Cost ($)
                                <span class="info-icon"
                                    data-tooltip="Cost of your PEI, Glass, or other build plate.">i</span>
                            </label>
                            <input type="number" id="build_plate_cost" value="30" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="build_plate_lifespan_hr" class="block text-sm font-medium text-gray-700">
                                Build Plate Lifespan (hours)
                                <span class="info-icon"
                                    data-tooltip="Estimated total lifespan in print hours (e.g., PEI/Glass: 5000+).">i</span>
                            </label>
                            <input type="number" id="build_plate_lifespan_hr" value="5000" min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                        <!-- Model Nozzle -->
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="model_nozzle_cost" class="block text-sm font-medium text-gray-700">
                                Model Nozzle Cost ($)
                                <span class="info-icon"
                                    data-tooltip="Cost of the nozzle for the model material. (e.g., Brass: $2, Hardened Steel: $15)">i</span>
                            </label>
                            <input type="number" id="model_nozzle_cost" value="2" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="model_nozzle_lifespan_kg" class="block text-sm font-medium text-gray-700">
                                Model Nozzle Lifespan (kg)
                                <span class="info-icon"
                                    data-tooltip="Estimated filament mass (in kg) this nozzle can print. See guide below. (e.g., Brass/PLA: 25kg, Brass/CF: 0.5kg)">i</span>
                            </label>
                            <input type="number" id="model_nozzle_lifespan_kg" value="25" min="0.1" step="0.1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                        <!-- Support Nozzle -->
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="support_nozzle_cost" class="block text-sm font-medium text-gray-700">
                                Support Nozzle Cost ($)
                                <span class="info-icon"
                                    data-tooltip="Cost of the nozzle for the support material. (If same as model, enter 0 and use model nozzle fields)">i</span>
                            </label>
                            <input type="number" id="support_nozzle_cost" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="support_nozzle_lifespan_kg" class="block text-sm font-medium text-gray-700">
                                Support Nozzle Lifespan (kg)
                                <span class="info-icon"
                                    data-tooltip="Estimated filament mass (in kg) this nozzle can print. (Only if using a separate nozzle for support)">i</span>
                            </label>
                            <input type="number" id="support_nozzle_lifespan_kg" value="25" min="0.1" step="0.1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 6: Finishing & Post-Processing (Optional) -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">6. Finishing & Post-Processing
                        (Optional)</h2>

                    <!-- Mechanical Finishing -->
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Mechanical Finishing</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="finishing_labor_time_part" class="block text-sm font-medium text-gray-700">
                                Finishing Labor (min/part)
                                <span class="info-icon"
                                    data-tooltip="Time spent *per part* on sanding, painting, assembly, etc. Added to your total labor cost.">i</span>
                            </label>
                            <input type="number" id="finishing_labor_time_part" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="finishing_materials_cost" class="block text-sm font-medium text-gray-700">
                                Finishing Materials ($/build plate)
                                <span class="info-icon"
                                    data-tooltip="Cost of non-filament materials *per build plate* (primer, paint, glue, screws).">i</span>
                            </label>
                            <input type="number" id="finishing_materials_cost" value="0" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <!-- Chemical Post-Processing -->
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Chemical Post-Processing (Eq 2)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="solvent_cost_liter" class="block text-sm font-medium text-gray-700">
                                Solvent Cost ($/Liter)
                                <span class="info-icon"
                                    data-tooltip="Cost per liter of your solvent (e.g., D-Limonene for HIPS, Water for PVA). 1 Liter = 1000 cm³">i</span>
                            </label>
                            <input type="number" id="solvent_cost_liter" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="solving_time_hr" class="block text-sm font-medium text-gray-700">
                                Solving Time (hours)
                                <span class="info-icon"
                                    data-tooltip="Time the part spends in the solvent bath.">i</span>
                            </label>
                            <input type="number" id="solving_time_hr" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="tank_power_w" class="block text-sm font-medium text-gray-700">
                                Tank Power (Watts)
                                <span class="info-icon"
                                    data-tooltip="Average power consumption of the solvent tank (heater, stirrer).">i</span>
                            </label>
                            <input type="number" id="tank_power_w" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 7: Markup -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">7. Markup (Optional)</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="markup_percent" class="block text-sm font-medium text-gray-700">
                                Overhead & Profit Markup (%)
                                <span class="info-icon"
                                    data-tooltip="A percentage markup applied to the total cost per part for business overhead and profit. (e.g., 50)">i</span>
                            </label>
                            <input type="number" id="markup_percent" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Reference Guides (Collapsible) -->
                <div class="bg-white rounded-lg shadow-md p-6 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Reference Guides</h2>

                    <!-- Nozzle Lifespan Guide -->
                    <details>
                        <summary class="text-lg">Nozzle Lifespan Reference Guide</summary>
                        <div class="space-y-4">
                            <p class="text-sm text-gray-600">Nozzle lifespan depends on the nozzle material and the
                                filament being printed. Abrasive filaments (carbon fiber, glow-in-the-dark, wood-fill)
                                will destroy brass nozzles very quickly.</p>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Nozzle Material
                                            </th>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Filament Type</th>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Est. Lifespan (kg)
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td class="px-4 py-2 font-medium">Brass</td>
                                            <td class="px-4 py-2">Standard (PLA, ABS, PETG)</td>
                                            <td class="px-4 py-2">10 - 25 kg+</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">Brass</td>
                                            <td class="px-4 py-2 text-red-600">Abrasive (CF, Wood, Glow)</td>
                                            <td class="px-4 py-2 text-red-600">&lt; 1 kg (as low as 0.25 kg)</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">Stainless Steel</td>
                                            <td class="px-4 py-2">Standard & Light Abrasive</td>
                                            <td class="px-4 py-2">20 - 50 kg+</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">Hardened Steel</td>
                                            <td class="px-4 py-2">All, incl. Heavy Abrasive</td>
                                            <td class="px-4 py-2">50 - 100 kg+</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">Ruby / Nozzle X</td>
                                            <td class="px-4 py-2">All, incl. Heavy Abrasive</td>
                                            <td class="px-4 py-2">100 kg++</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </details>

                    <!-- Nozzle Size Guide -->
                    <details>
                        <summary class="text-lg">Nozzle Size Reference Guide</summary>
                        <div class="space-y-4">
                            <p class="text-sm text-gray-600">Nozzle diameter (size) is a trade-off between print speed
                                and detail.</p>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Nozzle Size (mm)
                                            </th>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Typical Use Case
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td class="px-4 py-2 font-medium">0.15 - 0.25</td>
                                            <td class="px-4 py-2">Extreme detail (e.g., miniatures), very slow. Prone to
                                                clogging.</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">0.40 (Standard)</td>
                                            <td class="px-4 py-2">Best all-around balance of speed and detail. Default
                                                on most printers.</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">0.60</td>
                                            <td class="px-4 py-2">Faster prints, stronger parts. Good for abrasive
                                                filaments. Loses fine detail.</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">0.80 - 1.00+</td>
                                            <td class="px-4 py-2">Very fast "draft" prints or large structural parts.
                                                Very low detail.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- Footer / References -->
                <footer class="mt-4 text-gray-600 text-xs">
                    <h3 class="font-semibold text-gray-700 mb-2">References</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>
                            Seregi, B.L.; Ficzere, P. (2025). Refined Cost Calculation Framework for FDM Parts.
                            <a href="https://www.mdpi.com/2504-4494/9/9/321" target="_blank" rel="noopener noreferrer"
                                class="text-blue-600 hover:underline">
                                jmmp-09-00321
                            </a>
                        </li>
                        <li>
                            Simplify3D (n.d.). Filament Properties Table.
                            <a href="https://www.simplify3d.com/resources/materials-guide/properties-table/"
                                target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                                simplify3d.com
                            </a>
                        </li>
                        <li>
                            Nozzle material & lifespan guides (All3DP, Sovol, Creality, 3DJake, etc.)
                        </li>
                        <li>
                            Build plate guides (All3DP, Bambu Lab Forum, Reddit, etc.)
                        </li>
                        <li>
                            Fusion3 Design (n.d.). How Much Does a 3D Printer Cost?
                            <a href="https://www.fusion3design.com/how-much-does-a-3d-printer-cost/" target="_blank"
                                rel="noopener noreferrer" class="text-blue-600 hover:underline">
                                fusion3design.com
                            </a>
                        </li>
                        <li>
                            Machine maintenance guides (EufyMake, Raise3D, Qidi, etc.)
                        </li>
                    </ul>
                </footer>

            </div> <!-- End Column 1 -->

            <!-- Column 2: Cost Summary (Sticky) -->
            <div class="sticky-summary">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-900 border-b pb-3 mb-4">Cost Summary</h2>

                    <!-- Main Display Box -->
                    <div class="bg-blue-600 text-white rounded-lg p-6 mb-4 text-center">
                        <label class="block text-sm font-medium text-blue-200">Final Quoted Price (per Part)</label>
                        <div id="summary_final_quote" class="text-5xl font-bold tracking-tight">
                            $0.00
                        </div>
                        <div id="summary_total_cost_per_part" class="text-sm text-blue-100 opacity-80 mt-1">
                            ($0.00 base cost + $0.00 markup)
                        </div>
                    </div>

                    <!-- Generate Quote Button -->
                    <button id="generate_quote_btn"
                        class="w-full bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 mb-4">
                        Generate Printable Quote
                    </button>

                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center text-sm font-medium text-gray-600">
                            <span>Total Build Plate Cost (for <span id="summary_parts_count_1">1</span> part):</span>
                            <span id="summary_total_build_plate_cost" class="text-gray-900">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm font-medium text-gray-600 mt-1">
                            <span>Base Cost (per Part):</span>
                            <span id="summary_base_cost_per_part" class="text-gray-900">$0.00</span>
                        </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Cost Breakdown (per Build Plate)</h3>

                    <!-- Pie Chart & Legend -->
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                        <div id="pie-chart" class="flex-shrink-0"></div>
                        <div id="pie-legend" class="text-sm space-y-1 w-full">
                            <!-- Legend items inserted by JS -->
                            <div class="flex items-center justify-between">
                                <div><span class="inline-block w-3 h-3 rounded-full mr-2"
                                        style="background-color: #3b82f6;"></span>Material</div>
                                <div id="legend_material" class="font-medium">$0.00 (0%)</div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div><span class="inline-block w-3 h-3 rounded-full mr-2"
                                        style="background-color: #10b981;"></span>Labor</div>
                                <div id="legend_labor" class="font-medium">$0.00 (0%)</div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div><span class="inline-block w-3 h-3 rounded-full mr-2"
                                        style="background-color: #f59e0b;"></span>Machine</div>
                                <div id="legend_machine" class="font-medium">$0.00 (0%)</div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div><span class="inline-block w-3 h-3 rounded-full mr-2"
                                        style="background-color: #ef4444;"></span>Tooling</div>
                                <div id="legend_tooling" class="font-medium">$0.00 (0%)</div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div><span class="inline-block w-3 h-3 rounded-full mr-2"
                                        style="background-color: #8b5cf6;"></span>Finishing</div>
                                <div id="legend_finishing" class="font-medium">$0.00 (0%)</div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2 text-sm">
                        <!-- Material -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">1. Material Cost</span>
                            <span id="summary_material_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Labor -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">2. Labor Cost</span>
                            <span id="summary_labor_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Machine -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">3. Machine Operation</span>
                            <span id="summary_machine_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Tooling -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">4. Tooling</span>
                            <span id="summary_tooling_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Finishing -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">5. Finishing & Post-Processing</span>
                            <span id="summary_post_processing_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <div class="border-t my-2"></div>
                        <!-- Subtotal -->
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-800">Subtotal (Base Cost)</span>
                            <span id="summary_subtotal_cost" class="font-bold text-gray-900">$0.00</span>
                        </div>
                        <!-- Failure Rate -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">Failure Rate Markup (<span
                                    id="summary_failure_rate">5</span>%)</span>
                            <span id="summary_failure_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Total -->
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-800">Total Build Plate Cost</span>
                            <span id="summary_total_cost" class="font-bold text-gray-900">$0.00</span>
                        </div>
                    </div>

                    <!-- Quick Metrics -->
                    <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-2">Quick Metrics</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Print Time</span>
                            <span id="summary_total_time" class="font-medium text-gray-900">1.00 hr</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Mass</span>
                            <span id="summary_total_mass" class="font-medium text-gray-900">10 g</span>
                        </div>
                        <div class="border-t my-2"></div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Cost per Print Hour</span>
                            <span id="summary_cost_per_hour" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Cost per Gram</span>
                            <span id="summary_cost_per_gram" class="font-medium text-gray-900">$0.00</span>
                        </div>
                    </div>

                    <!-- Message Box -->
                    <div id="message_box" class="hidden mt-4 p-3 rounded-md text-sm">
                        <!-- Messages inserted here -->
                    </div>

                </div>
            </div> <!-- End Column 2 -->
        </div> <!-- End Main Grid -->
    </div> <!-- End Container -->

    <!-- Quote Modal -->
    <div id="quote-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <!-- Backdrop -->
        <div id="quote-modal-backdrop" class="fixed inset-0"></div>

        <!-- Modal Content -->
        <div id="quote-modal-content"
            class="bg-white rounded-lg shadow-2xl z-10 w-full max-w-2xl border border-gray-300">
            <div id="quote-modal-header" class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-semibold text-gray-800">Print Job Quote</h2>
                <button id="quote-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-8">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900">Quote</h3>
                        <p class="text-sm text-gray-500">Generated: <span id="quote_date">--</span></p>
                    </div>
                    <div class="text-right">
                        <h4 class="text-lg font-semibold text-gray-700">From:</h4>
                        <p class="text-gray-600">My 3D Printing Service</p>
                        <!-- You can add more 'From' details here -->
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">To:</h4>
                    <p id="quote_customer_name" class="text-gray-600">N/A</p>
                </div>

                <h4 class="text-lg font-semibold text-gray-700 mb-2">Project Details:</h4>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-6 py-3 text-sm font-medium text-gray-500 whitespace-nowrap">Part/Project
                                    Name</td>
                                <td id="quote_part_name_val" class="px-6 py-3 text-sm text-gray-900 font-medium">--</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 text-sm font-medium text-gray-500 whitespace-nowrap">Model Material
                                </td>
                                <td id="quote_material_val" class="px-6 py-3 text-sm text-gray-900">--</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 text-sm font-medium text-gray-500 whitespace-nowrap">Est. Print
                                    Time</td>
                                <td id="quote_time_val" class="px-6 py-3 text-sm text-gray-900">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Pricing:</h4>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Item</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Quantity</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Price per Part</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td id="quote_item_name" class="px-6 py-4 text-sm font-medium text-gray-900">--</td>
                                <td id="quote_quantity_val" class="px-6 py-4 text-sm text-gray-700 text-right">--</td>
                                <td id="quote_price_per_val" class="px-6 py-4 text-sm text-gray-700 text-right">--</td>
                                <td id="quote_total_val" class="px-6 py-4 text-sm font-medium text-gray-900 text-right">
                                    --</td>
                            </tr>
                        </tbody>
                        <tfoot class="bg-gray-50">
                            <tr>
                                <td colspan="3" class="px-6 py-3 text-right text-sm font-bold text-gray-800 uppercase">
                                    Grand Total</td>
                                <td id="quote_grand_total_val"
                                    class="px-6 py-3 text-right text-sm font-bold text-gray-900">--</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="mt-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Notes:</h4>
                    <textarea id="quote_notes_input"
                        class="w-full h-24 p-2 border rounded-md text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., Estimated lead time: 3-5 business days. Price valid for 30 days."></textarea>
                </div>
            </div>

            <div id="quote-modal-footer" class="flex justify-end items-center p-4 bg-gray-50 border-t rounded-b-lg">
                <button id="quote-modal-print"
                    class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Print Quote
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA & CONSTANTS ---

            // Data from Simplify3D Properties Table
            const materialProperties = {
                '1.24': { // PLA
                    name: 'PLA',
                    density: 1.24,
                    extruderTemp: '190-230 °C',
                    bedTemp: '20-60 °C',
                    surface: 'Blue painter\'s tape, glue stick, PEI sheet'
                },
                '1.27': { // PETG
                    name: 'PETG',
                    density: 1.27,
                    extruderTemp: '220-250 °C',
                    bedTemp: '50-75 °C',
                    surface: 'Blue painter\'s tape, PEI sheet (w/ glue stick as release agent)'
                },
                '1.04': { // ABS
                    name: 'ABS',
                    density: 1.04,
                    extruderTemp: '210-250 °C',
                    bedTemp: '80-110 °C',
                    surface: 'Kapton tape, ABS slurry, PEI sheet'
                },
                '1.06': { // ASA
                    name: 'ASA',
                    density: 1.06,
                    extruderTemp: '240-260 °C',
                    bedTemp: '90-110 °C',
                    surface: 'Kapton tape, PEI sheet'
                },
                '1.20': { // TPU/TPE
                    name: 'TPU/TPE',
                    density: 1.20,
                    extruderTemp: '210-230 °C',
                    bedTemp: '20-60 °C',
                    surface: 'Blue painter\'s tape, glue stick'
                },
                '1.08': { // Nylon (PA)
                    name: 'Nylon (PA)',
                    density: 1.08,
                    extruderTemp: '240-260 °C',
                    bedTemp: '70-90 °C',
                    surface: 'Garolite sheet, glue stick on glass'
                },
                '1.21': { // Polycarbonate (PC)
                    name: 'Polycarbonate (PC)',
                    density: 1.20,
                    extruderTemp: '270-310 °C',
                    bedTemp: '90-110 °C',
                    surface: 'Garolite sheet, PEI sheet with glue stick'
                },
                'custom': {
                    name: 'Custom',
                    density: null, // Will be user-defined
                    extruderTemp: 'N/A',
                    bedTemp: 'N/A',
                    surface: 'Refer to manufacturer'
                },
                // Support-specific materials
                '1.25': { // PVA
                    name: 'PVA',
                    density: 1.25,
                    extruderTemp: '190-220 °C',
                    bedTemp: '20-60 °C',
                    surface: 'Blue painter\'s tape, PEI sheet (dissolves in water)'
                },
                '1.07': { // HIPS
                    name: 'HIPS',
                    density: 1.07,
                    extruderTemp: '220-240 °C',
                    bedTemp: '90-110 °C',
                    surface: 'Kapton tape, PEI (dissolves in D-Limonene)'
                }
            };


            // --- DOM Elements ---
            const allInputs = document.querySelectorAll('input, select');
            const messageBox = document.getElementById('message_box');
            const saveProfileButton = document.getElementById('save_profile');
            const loadProfileButton = document.getElementById('load_profile');
            const saveMaterialButton = document.getElementById('save_custom_material');
            const pieChartEl = document.getElementById('pie-chart');

            // Quote Modal Elements
            const quoteModal = document.getElementById('quote-modal');
            const quoteModalCloseBtn = document.getElementById('quote-modal-close');
            const quoteModalBackdrop = document.getElementById('quote-modal-backdrop');
            const generateQuoteBtn = document.getElementById('generate_quote_btn');
            const printQuoteBtn = document.getElementById('quote-modal-print');

            // --- Storage Availability Check ---
            let storageAvailable = false;
            try {
                const testKey = 'fdm_calc_storage_test';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                storageAvailable = true;
            } catch (e) {
                storageAvailable = false;
                console.warn("LocalStorage is not available. Profile/Material saving will be disabled.");
                // Disable buttons and show a persistent error
                if (saveProfileButton) saveProfileButton.disabled = true;
                if (loadProfileButton) loadProfileButton.disabled = true;
                if (saveMaterialButton) saveMaterialButton.disabled = true;
                if (saveProfileButton) saveProfileButton.classList.add('opacity-50', 'cursor-not-allowed');
                if (loadProfileButton) loadProfileButton.classList.add('opacity-50', 'cursor-not-allowed');
                if (saveMaterialButton) saveMaterialButton.classList.add('opacity-50', 'cursor-not-allowed');

                // Show a message in the *main* message box
                if (messageBox) {
                    messageBox.textContent = 'Profile & Material saving is disabled: Browser storage is not available or blocked.';
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-yellow-100 text-yellow-800';
                    messageBox.classList.remove('hidden');
                }
            }

            const CUSTOM_MATERIALS_KEY = 'fdmCustomMaterials';
            let lastCalculatedCosts = {}; // Store results for the quote modal

            // --- HELPER FUNCTIONS ---

            /**
             * Gets the numeric value from an input field.
             * @param {string} id - The ID of the input element.
             * @returns {number} The parsed float value, or 0 if invalid.
             */
            function getVal(id) {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`Element with ID ${id} not found.`);
                    return 0;
                }
                const val = parseFloat(el.value);
                return isNaN(val) ? 0 : val;
            }

            /**
             * Gets the string value from an input field.
             * @param {string} id - The ID of the input element.
             * @returns {string} The value.
             */
            function getStr(id) {
                const el = document.getElementById(id);
                return el ? el.value : '';
            }

            /**
             * Formats a number as a currency string.
             * @param {number} num - The number to format.
             * @returns {string} The formatted currency string (e.g., "$1.23").
             */
            function formatCurrency(num) {
                if (isNaN(num)) return "$0.00";
                return num.toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            /**
             * Formats a number to a fixed number of decimal places.
             * @param {number} num - The number to format.
             * @param {number} places - The number of decimal places.
             * @returns {string} The formatted number string.
             */
            function formatNum(num, places = 2) {
                if (isNaN(num)) return (0).toFixed(places);
                return num.toFixed(places);
            }

            /**
             * Displays a message to the user.
             * @param {string} text - The message text.
             * @param {'success' | 'error' | 'warn'} type - The message type.
             */
            function showMessage(text, type = 'success') {
                if (!messageBox) return; // Guard clause
                messageBox.textContent = text;
                if (type === 'success') {
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-green-100 text-green-800';
                } else if (type === 'error') {
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-red-100 text-red-800';
                } else { // 'warn'
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-yellow-100 text-yellow-800';
                }
                messageBox.classList.remove('hidden');

                // Hide message after 3 seconds, unless it's the storage warning
                if (text.includes('Browser storage')) return;

                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            }

            /**
             * Toggles the visibility of the custom density input.
             * @param {string} selectId - The ID of the material <select> element.
             * @param {string} wrapperId - The ID of the custom density wrapper <div>.
             */
            function toggleCustomDensity(selectId, wrapperId) {
                const select = document.getElementById(selectId);
                const wrapper = document.getElementById(wrapperId);
                if (!select || !wrapper) return;
                if (select.value === 'custom') {
                    wrapper.classList.remove('hidden');
                } else {
                    wrapper.classList.add('hidden');
                }
            }

            /**
             * Gets the density for a selected material.
             * @param {string} typeSelectId - The ID of the material type dropdown.
             * @param {string} customInputId - The ID of the custom density input.
             * @returns {number} The density in g/cm³.
             */
            function getDensity(typeSelectId, customInputId) {
                const typeVal = getStr(typeSelectId);
                if (typeVal === 'custom') {
                    return getVal(customInputId);
                }

                // Check standard properties
                if (materialProperties[typeVal]) {
                    return materialProperties[typeVal].density;
                }

                // Check custom materials (value will be density_name)
                if (typeVal.includes('_')) {
                    return parseFloat(typeVal.split('_')[0]);
                }

                return 1.24; // Default to PLA density if not found
            }

            /**
             * Gets the name for a selected material.
             * @param {string} typeSelectId - The ID of the material type dropdown.
             * @returns {string} The material name.
             */
            function getMaterialName(typeSelectId) {
                const select = document.getElementById(typeSelectId);
                if (!select) return "N/A";

                const typeVal = select.value;

                // Check standard properties
                if (materialProperties[typeVal]) {
                    return materialProperties[typeVal].name;
                }

                // Check custom materials (value will be density_name)
                if (typeVal.includes('_')) {
                    return typeVal.split('_')[1];
                }

                return "N/A";
            }

            /**
             * Updates the material info box.
             * @param {string} selectId - The ID of the material <select> element.
             * @param {string} infoBoxId - The ID of the info box <div>.
             */
            function updateMaterialInfo(selectId, infoBoxId) {
                const select = document.getElementById(selectId);
                const infoBox = document.getElementById(infoBoxId);
                if (!select || !infoBox) return;
                const key = select.value;

                if (key === 'custom') {
                    infoBox.innerHTML = `<p class="text-gray-700">Please add a new custom material from the "My Material Library" card below, or temporarily enter a density if this is a one-time use.</p>`;
                    return;
                }

                let props;
                if (materialProperties[key]) {
                    props = materialProperties[key];
                } else if (key.includes('_')) {
                    // Custom material
                    const parts = key.split('_');
                    props = {
                        name: parts[1],
                        density: parseFloat(parts[0]),
                        extruderTemp: 'N/A',
                        bedTemp: 'N/A',
                        surface: 'Refer to manufacturer'
                    };
                } else {
                    infoBox.innerHTML = '';
                    return;
                }

                infoBox.innerHTML = `
                    <strong class="text-gray-900">${props.name} Properties:</strong>
                    <ul class="list-disc list-inside ml-1 text-gray-700 space-y-1 mt-1">
                        <li><strong>Density:</strong> ${props.density} g/cm³</li>
                        <li><strong>Extruder Temp:</strong> ${props.extruderTemp}</li>
                        <li><strong>Bed Temp:</strong> ${props.bedTemp}</li>
                        <li><strong>Build Surface:</strong> ${props.surface}</li>
                    </ul>
                `;
            }


            // --- MAIN CALCULATION ---

            function calculateCost() {
                // --- 1. Get All Input Values ---

                // Job Parameters
                const N_parts = getVal('parts_per_program');
                const t_program = getVal('program_length_hr'); // hours
                const m_model_g = getVal('model_material_g'); // grams
                const m_support_g = getVal('support_material_g'); // grams
                const failure_rate = getVal('failure_rate') / 100; // as decimal

                // Material & Labor
                const p_model_kg = getVal('model_material_cost_kg'); // $/kg
                const p_support_kg = getVal('support_material_cost_kg'); // $/kg
                const p_hourlywage = getVal('hourly_wage'); // $/hour
                const t_prep_min = getVal('prep_slicing_time'); // minutes/build plate
                const t_manual_min = getVal('manual_labor_time'); // minutes/build plate

                // Densities
                const d_model = getDensity('model_material_type', 'model_material_density_custom'); // g/cm³
                const d_support = getDensity('support_material_type', 'support_material_density_custom'); // g/cm³

                // Machine Operation
                const p_printer = getVal('printer_cost');
                const t_printer_lifespan = getVal('printer_lifespan_hr');
                const p_maintenance_hr = getVal('maintenance_cost_hr');
                const E_machine_w = getVal('machine_power_w'); // watts
                const p_electricity_kwh = getVal('electricity_cost_kwh'); // $/kWh

                // Tooling
                const p_bed = getVal('build_plate_cost');
                const t_bed_lifespan = getVal('build_plate_lifespan_hr');
                const p_model_tip = getVal('model_nozzle_cost');
                const m_model_tip_lifespan_kg = getVal('model_nozzle_lifespan_kg'); // kg
                const p_support_tip = getVal('support_nozzle_cost');
                const m_support_tip_lifespan_kg = getVal('support_nozzle_lifespan_kg'); // kg

                // Finishing & Post-Processing
                const t_finishing_min_part = getVal('finishing_labor_time_part'); // minutes/part
                const p_finishing_materials = getVal('finishing_materials_cost'); // $/build plate
                const p_solvent_liter = getVal('solvent_cost_liter'); // $/Liter
                const t_solving_hr = getVal('solving_time_hr'); // hours
                const E_tank_w = getVal('tank_power_w'); // watts

                // Markup
                const markup_percent = getVal('markup_percent') / 100; // as decimal

                // --- 2. Perform Calculations (based on article) ---

                // --- Helper Calcs: Volumes (V) ---
                // Volume = Mass / Density. V_model and V_support in cm³
                const V_model_total = (d_model > 0) ? (m_model_g / d_model) : 0;
                const V_support_total = (d_support > 0) ? (m_support_g / d_support) : 0;

                // --- Helper Calcs: Lifespan Conversions ---
                // Convert Nozzle Lifespan from mass (kg) to volume (cm³)
                // Lifetime_Volume = (Lifetime_Mass_g / Density)
                const V_m_lifespan = (d_model > 0) ? ((m_model_tip_lifespan_kg * 1000) / d_model) : 0;
                const V_s_lifespan = (d_support > 0) ? ((m_support_tip_lifespan_kg * 1000) / d_support) : 0;


                // --- Cost Component 1: Material (C_material) (Eq 1, modified) ---
                // We use mass (g) and price per kg ($/kg)
                const C_model = (m_model_g / 1000) * p_model_kg;
                const C_support = (m_support_g / 1000) * p_support_kg;
                const C_material_build_plate = C_model + C_support;

                // --- Cost Component 2: Labor (C_labor) (Eq 6, v2) ---
                const t_build_plate_labor_min = t_prep_min + t_manual_min;
                const t_part_labor_min = t_finishing_min_part * N_parts;
                const t_total_labor_hr = (t_build_plate_labor_min + t_part_labor_min) / 60;
                const C_labor_build_plate = p_hourlywage * t_total_labor_hr;

                // --- Cost Component 3: Machine Operation (C_machine) (Eq 3 & 4, expanded) ---
                // C_depreciation ($/hr) = Printer Cost / Printer Lifespan
                const C_depreciation_hr = (t_printer_lifespan > 0) ? (p_printer / t_printer_lifespan) : 0;
                // C_power ($/hr) = (Watts / 1000) * $/kWh
                const C_power_hr = (E_machine_w / 1000) * p_electricity_kwh;
                // C_machine_hr = Depreciation + Maintenance + Power
                const C_machine_hr = C_depreciation_hr + p_maintenance_hr + C_power_hr;
                const C_machine_build_plate = C_machine_hr * t_program;

                // --- Cost Component 4: Tooling (C_tooling) (Eq 5, modified) ---
                // C_bed = (Bed Cost / Bed Lifespan_hr) * Program_hr
                const C_bed = (t_bed_lifespan > 0) ? (p_bed / t_bed_lifespan) * t_program : 0;
                // C_nozzle = (Nozzle Cost / Nozzle Lifespan_cm³) * Volume_cm³
                const C_model_tip = (V_m_lifespan > 0) ? (p_model_tip / V_m_lifespan) * V_model_total : 0;
                // Check if separate support nozzle is used
                const C_support_tip = (p_support_tip > 0 && V_s_lifespan > 0) ?
                    (p_support_tip / V_s_lifespan) * V_support_total : 0;
                // If no separate support nozzle, add support volume to model nozzle wear
                const C_model_tip_extra_wear = (p_support_tip <= 0 && V_m_lifespan > 0) ?
                    (p_model_tip / V_m_lifespan) * V_support_total : 0;

                const C_tooling_build_plate = C_bed + C_model_tip + C_support_tip + C_model_tip_extra_wear;

                // --- Cost Component 5: Post-Processing (C_postprocess) (Eq 2) ---
                // C_solvent = (p_solvent_liter / 1000 cm³) * V_support_cm³
                const C_solvent = (p_solvent_liter / 1000) * V_support_total;
                // C_tank_power = (Tank_Watts / 1000) * $/kWh * Solving_Time_hr
                const C_tank_power = (E_tank_w / 1000) * p_electricity_kwh * t_solving_hr;
                const C_postprocess_build_plate = C_solvent + C_tank_power + p_finishing_materials;

                // --- 3. Calculate Totals (Eq 7, expanded) ---

                // C_subtotal_build_plate = Sum of all base costs
                const C_subtotal_build_plate = C_material_build_plate + C_labor_build_plate + C_machine_build_plate + C_tooling_build_plate + C_postprocess_build_plate;

                // C_failure_markup = Cost to account for failures
                const C_failure_markup = (failure_rate > 0 && failure_rate < 1) ?
                    (C_subtotal_build_plate / (1 - failure_rate)) - C_subtotal_build_plate : 0;

                // C_total_build_plate = Base cost + Failure markup
                const C_total_build_plate = C_subtotal_build_plate + C_failure_markup;

                // C_total_per_part = Total build plate cost / number of parts
                const C_total_per_part = (N_parts > 0) ? (C_total_build_plate / N_parts) : 0;

                // C_markup_per_part = Markup % applied to cost per part
                const C_markup_per_part = C_total_per_part * markup_percent;

                // C_final_quote = Final price to charge customer
                const C_final_quote = C_total_per_part + C_markup_per_part;

                // --- 4. Calculate Quick Metrics ---
                const total_mass_g = m_model_g + m_support_g;
                const C_per_hour = (t_program > 0) ? (C_total_build_plate / t_program) : 0;
                const C_per_gram = (total_mass_g > 0) ? (C_total_build_plate / total_mass_g) : 0;

                // --- 5. Store values for Quote Modal ---
                lastCalculatedCosts = {
                    C_final_quote, C_total_per_part, C_markup_per_part,
                    C_total_build_plate, C_material_build_plate, C_labor_build_plate,
                    C_machine_build_plate, C_tooling_build_plate, C_postprocess_build_plate,
                    C_subtotal_build_plate, C_failure_markup,
                    N_parts, t_program, total_mass_g, C_per_hour, C_per_gram
                };

                // --- 6. Update UI ---

                // Main Display
                document.getElementById('summary_final_quote').textContent = formatCurrency(C_final_quote);
                document.getElementById('summary_total_cost_per_part').textContent = `(${formatCurrency(C_total_per_part)} base cost + ${formatCurrency(C_markup_per_part)} markup)`;

                // Program/Part Summary
                document.getElementById('summary_parts_count_1').textContent = N_parts;
                document.getElementById('summary_total_build_plate_cost').textContent = formatCurrency(C_total_build_plate);
                document.getElementById('summary_base_cost_per_part').textContent = formatCurrency(C_total_per_part);

                // Cost Breakdown
                document.getElementById('summary_material_cost').textContent = formatCurrency(C_material_build_plate);
                document.getElementById('summary_labor_cost').textContent = formatCurrency(C_labor_build_plate);
                document.getElementById('summary_machine_cost').textContent = formatCurrency(C_machine_build_plate);
                document.getElementById('summary_tooling_cost').textContent = formatCurrency(C_tooling_build_plate);
                document.getElementById('summary_post_processing_cost').textContent = formatCurrency(C_postprocess_build_plate);

                document.getElementById('summary_subtotal_cost').textContent = formatCurrency(C_subtotal_build_plate);
                document.getElementById('summary_failure_rate').textContent = formatNum(failure_rate * 100, 0);
                document.getElementById('summary_failure_cost').textContent = formatCurrency(C_failure_markup);
                document.getElementById('summary_total_cost').textContent = formatCurrency(C_total_build_plate);

                // Quick Metrics
                document.getElementById('summary_total_time').textContent = `${formatNum(t_program, 2)} hr`;
                document.getElementById('summary_total_mass').textContent = `${formatNum(total_mass_g, 1)} g`;
                document.getElementById('summary_cost_per_hour').textContent = formatCurrency(C_per_hour);
                document.getElementById('summary_cost_per_gram').textContent = formatCurrency(C_per_gram);

                // Update Pie Chart
                updatePieChart([
                    { id: 'legend_material', value: C_material_build_plate, color: '#3b82f6' }, // Blue
                    { id: 'legend_labor', value: C_labor_build_plate, color: '#10b981' }, // Green
                    { id: 'legend_machine', value: C_machine_build_plate, color: '#f59e0b' }, // Amber
                    { id: 'legend_tooling', value: C_tooling_build_plate, color: '#ef4444' }, // Red
                    { id: 'legend_finishing', value: C_postprocess_build_plate, color: '#8b5cf6' } // Violet
                ]);
            }

            /**
             * Updates the CSS conic-gradient pie chart and its legend.
             * @param {Array<Object>} costs - Array of cost objects {id, value, color}
             */
            function updatePieChart(costs) {
                const total = costs.reduce((acc, cost) => acc + cost.value, 0);
                let gradientString = '';
                let currentPercent = 0;

                for (const cost of costs) {
                    const percent = (total > 0) ? (cost.value / total) * 100 : 0;
                    const percentStr = `(${formatNum(percent, 0)}%)`;

                    // Update legend
                    const legendEl = document.getElementById(cost.id);
                    if (legendEl) {
                        legendEl.textContent = `${formatCurrency(cost.value)} ${percentStr}`;
                    }

                    // Build gradient string
                    if (percent > 0) {
                        const nextPercent = currentPercent + percent;
                        gradientString += `${cost.color} ${currentPercent}% ${nextPercent}%, `;
                        currentPercent = nextPercent;
                    }
                }

                // Set chart background
                if (pieChartEl) {
                    if (total > 0) {
                        pieChartEl.style.backgroundImage = `conic-gradient(${gradientString.slice(0, -2)})`;
                    } else {
                        // Default to gray if no costs
                        pieChartEl.style.backgroundImage = `conic-gradient(#e5e7eb 0% 100%)`;
                    }
                }
            }

            // --- PROFILE SAVE/LOAD ---

            // List of all input IDs that are *not* job-specific
            const profileInputIds = [
                'markup_percent', 'printer_cost', 'printer_lifespan_hr', 'maintenance_cost_hr',
                'machine_power_w', 'electricity_cost_kwh',
                'model_material_cost_kg', 'model_material_type', 'model_material_density_custom',
                'support_material_cost_kg', 'support_material_type', 'support_material_density_custom',
                'hourly_wage',
                'prep_slicing_time', 'manual_labor_time', // v2: Added build plate-level labor
                'build_plate_cost', 'build_plate_lifespan_hr',
                'model_nozzle_cost', 'model_nozzle_lifespan_kg',
                'support_nozzle_cost', 'support_nozzle_lifespan_kg',
                'solvent_cost_liter', 'tank_power_w'
                // Note: finishing_labor_time_part and finishing_materials_cost are job-specific
            ];

            function saveProfile() {
                if (!storageAvailable) {
                    showMessage('Error: Browser storage is not available or blocked.', 'error');
                    return;
                }
                try {
                    const profile = {};
                    for (const id of profileInputIds) {
                        const el = document.getElementById(id);
                        if (el) {
                            profile[id] = el.value;
                        }
                    }
                    localStorage.setItem('fdmCalculatorProfile', JSON.stringify(profile));
                    showMessage('Printer profile saved successfully!', 'success');
                } catch (error) {
                    console.error("Failed to save profile:", error);
                    showMessage('Error saving profile. Storage may be full or blocked by browser settings.', 'error');
                }
            }

            function loadProfile() {
                if (!storageAvailable) {
                    showMessage('Error: Browser storage is not available or blocked.', 'error');
                    return;
                }
                try {
                    const profileString = localStorage.getItem('fdmCalculatorProfile');
                    if (!profileString) {
                        showMessage('No saved profile found.', 'error');
                        return;
                    }
                    const profile = JSON.parse(profileString);
                    for (const id of profileInputIds) {
                        if (profile[id] !== undefined) {
                            const el = document.getElementById(id);
                            if (el) {
                                el.value = profile[id];
                            }
                        }
                    }

                    // Trigger updates for custom fields and info boxes
                    toggleCustomDensity('model_material_type', 'model_material_density_custom_wrapper');
                    toggleCustomDensity('support_material_type', 'support_material_density_custom_wrapper');
                    updateMaterialInfo('model_material_type', 'model_material_info');
                    updateMaterialInfo('support_material_type', 'support_material_info');

                    // Recalculate
                    calculateCost();
                    showMessage('Profile loaded successfully!', 'success');
                } catch (error) {
                    console.error("Failed to load profile:", error);
                    showMessage('Error loading profile. Data may be corrupt or blocked by browser settings.', 'error');
                }
            }

            // --- CUSTOM MATERIAL MANAGER ---

            function getCustomMaterials() {
                if (!storageAvailable) return [];
                try {
                    const materialsString = localStorage.getItem(CUSTOM_MATERIALS_KEY);
                    return materialsString ? JSON.parse(materialsString) : [];
                } catch (e) {
                    return [];
                }
            }

            function saveCustomMaterials(materials) {
                if (!storageAvailable) return;
                try {
                    localStorage.setItem(CUSTOM_MATERIALS_KEY, JSON.stringify(materials));
                } catch (e) {
                    console.error("Failed to save custom materials:", e);
                    showMessage('Error saving custom material. Storage may be full.', 'error');
                }
            }

            function saveNewCustomMaterial() {
                const name = getStr('custom_material_name');
                const density = getVal('custom_material_density');

                if (!name || density <= 0) {
                    showMessage('Please enter a valid material name and density.', 'error');
                    return;
                }

                const newMaterial = { name, density };
                const materials = getCustomMaterials();

                // Check for duplicates
                if (materials.some(m => m.name.toLowerCase() === name.toLowerCase())) {
                    showMessage('A material with this name already exists.', 'error');
                    return;
                }

                materials.push(newMaterial);
                saveCustomMaterials(materials);
                populateCustomMaterialDropdowns();
                renderCustomMaterialList();

                // Clear inputs
                document.getElementById('custom_material_name').value = '';
                document.getElementById('custom_material_density').value = '';

                showMessage(`Material "${name}" saved!`, 'success');
            }

            function populateCustomMaterialDropdowns() {
                const materials = getCustomMaterials();
                const modelGroup = document.getElementById('model_material_custom_group');
                const supportGroup = document.getElementById('support_material_custom_group');

                if (!modelGroup || !supportGroup) return;

                // Clear existing options
                modelGroup.innerHTML = '';
                supportGroup.innerHTML = '';

                materials.forEach(material => {
                    const value = `${material.density}_${material.name}`;
                    const text = `${material.name} (${material.density} g/cm³)`;

                    const modelOption = new Option(text, value);
                    modelGroup.appendChild(modelOption);

                    const supportOption = new Option(text, value);
                    supportGroup.appendChild(supportOption);
                });
            }

            function renderCustomMaterialList() {
                const materials = getCustomMaterials();
                const listEl = document.getElementById('custom_material_list');
                if (!listEl) return;

                if (materials.length === 0) {
                    listEl.innerHTML = '<p>No custom materials saved.</p>';
                    return;
                }

                listEl.innerHTML = '<strong class="block mb-1">Saved Materials:</strong>';
                materials.forEach((material, index) => {
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                    el.innerHTML = `
                        <span>${material.name} (${material.density} g/cm³)</span>
                        <button data-index="${index}" class="remove-material-btn text-red-500 hover:text-red-700 text-xs font-medium">Remove</button>
                    `;
                    listEl.appendChild(el);
                });
            }

            function removeCustomMaterial(e) {
                if (!e.target.classList.contains('remove-material-btn')) return;

                const index = parseInt(e.target.getAttribute('data-index'), 10);
                let materials = getCustomMaterials();
                const removed = materials.splice(index, 1);
                saveCustomMaterials(materials);
                populateCustomMaterialDropdowns();
                renderCustomMaterialList();

                if (removed.length > 0) {
                    showMessage(`Material "${removed[0].name}" removed.`, 'success');
                }
            }

            // --- QUOTE MODAL ---

            function openQuoteModal() {
                // Populate modal with data from last calculation
                const customer = getStr('quote_customer') || "N/A";
                const partName = getStr('quote_part_name') || "N/A";
                const materialName = getMaterialName('model_material_type');

                document.getElementById('quote_date').textContent = new Date().toLocaleDateString();
                document.getElementById('quote_customer_name').textContent = customer;
                document.getElementById('quote_part_name_val').textContent = partName;
                document.getElementById('quote_material_val').textContent = materialName;
                document.getElementById('quote_time_val').textContent = `${formatNum(lastCalculatedCosts.t_program, 2)} hr`;

                document.getElementById('quote_item_name').textContent = partName;
                document.getElementById('quote_quantity_val').textContent = lastCalculatedCosts.N_parts;
                document.getElementById('quote_price_per_val').textContent = formatCurrency(lastCalculatedCosts.C_final_quote);

                const total = lastCalculatedCosts.C_final_quote * lastCalculatedCosts.N_parts;
                document.getElementById('quote_total_val').textContent = formatCurrency(total);
                document.getElementById('quote_grand_total_val').textContent = formatCurrency(total);

                if (quoteModal) quoteModal.classList.remove('hidden');
            }

            function closeQuoteModal() {
                if (quoteModal) quoteModal.classList.add('hidden');
            }

            function printQuote() {
                // Store notes value so it persists after print dialog
                const notes = document.getElementById('quote_notes_input');
                if (notes) notes.dataset.value = notes.value;

                window.print();

                // Restore value after print
                if (notes && notes.dataset.value) {
                    notes.value = notes.dataset.value;
                }
            }


            // --- EVENT LISTENERS ---

            // Add 'input' event listener to all inputs to recalculate
            allInputs.forEach(input => {
                input.addEventListener('input', calculateCost);
            });

            // Add listeners for custom density toggles
            document.getElementById('model_material_type').addEventListener('input', () => {
                toggleCustomDensity('model_material_type', 'model_material_density_custom_wrapper');
                updateMaterialInfo('model_material_type', 'model_material_info');
            });
            document.getElementById('support_material_type').addEventListener('input', () => {
                toggleCustomDensity('support_material_type', 'support_material_density_custom_wrapper');
                updateMaterialInfo('support_material_type', 'support_material_info');
            });

            // Add listeners for Save/Load buttons
            if (saveProfileButton) saveProfileButton.addEventListener('click', saveProfile);
            if (loadProfileButton) loadProfileButton.addEventListener('click', loadProfile);

            // Custom Material Listeners
            if (saveMaterialButton) saveMaterialButton.addEventListener('click', saveNewCustomMaterial);
            const materialListEl = document.getElementById('custom_material_list');
            if (materialListEl) materialListEl.addEventListener('click', removeCustomMaterial);

            // Quote Modal Listeners
            if (generateQuoteBtn) generateQuoteBtn.addEventListener('click', openQuoteModal);
            if (quoteModalCloseBtn) quoteModalCloseBtn.addEventListener('click', closeQuoteModal);
            if (quoteModalBackdrop) quoteModalBackdrop.addEventListener('click', closeQuoteModal);
            if (printQuoteBtn) printQuoteBtn.addEventListener('click', printQuote);

            // --- INITIALIZATION ---

            // Load custom materials into dropdowns
            populateCustomMaterialDropdowns();
            renderCustomMaterialList();

            // Run initial calculation on page load
            calculateCost();

            // Set initial state for info boxes
            updateMaterialInfo('model_material_type', 'model_material_info');
            updateMaterialInfo('support_material_type', 'support_material_info');

        }); // Close DOMContentLoaded
    </script>
</body>

</html>

