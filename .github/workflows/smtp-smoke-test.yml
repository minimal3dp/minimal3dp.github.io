name: SMTP Smoke Test

on:
  workflow_dispatch:
    inputs:
      to_override:
        description: "Optional comma-separated recipients (defaults to TO_EMAIL secret)"
        required: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          TO_EMAIL: ${{ github.event.inputs.to_override || secrets.TO_EMAIL }}
        run: |
          set -eu
          missing=""
          for v in SMTP_SERVER SMTP_PORT SMTP_USERNAME SMTP_PASSWORD FROM_EMAIL; do
            if [ -z "${!v:-}" ]; then missing="$missing $v"; fi
          done
          if [ -z "${TO_EMAIL:-}" ]; then missing="$missing TO_EMAIL"; fi
          if [ -n "$missing" ]; then
            echo "Missing required secret(s):$missing" >&2
            exit 1
          fi
      - name: Send test email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "SMTP Smoke Test âœ”"
          to: ${{ github.event.inputs.to_override || secrets.TO_EMAIL }}
          from: ${{ secrets.FROM_EMAIL }}
          body: |
            Hello from GitHub Actions SMTP smoke test.
            Repo: ${{ github.repository }}
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
