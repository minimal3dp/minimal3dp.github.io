<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="http://localhost:1313/tools/">
<link rel="alternate" type="application/rss&#43;xml" href="http://localhost:1313/tools/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>M3DP Tools | Minimal 3DP</title>
<meta name="description" content="Minimal 3DP Tools and Helper Scripts - A Work in Progress
Launched - 2025-11-08">
<meta property="og:url" content="http://localhost:1313/tools/">
  <meta property="og:site_name" content="Minimal 3DP">
  <meta property="og:title" content="M3DP Tools">
  <meta property="og:description" content="Minimal 3DP Tools and Helper Scripts - A Work in Progress
Launched - 2025-11-08">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="website">
    <meta property="og:image" content="http://localhost:1313/images/minimal3dp-og-1200x630.png">

  <meta itemprop="name" content="M3DP Tools">
  <meta itemprop="description" content="Minimal 3DP Tools and Helper Scripts - A Work in Progress
Launched - 2025-11-08">
  <meta itemprop="dateModified" content="2025-11-08T12:52:29-06:00">
  <meta itemprop="wordCount" content="14">
  <meta itemprop="image" content="http://localhost:1313/images/minimal3dp-og-1200x630.png">
  <meta itemprop="keywords" content="Calibration,How-To">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/images/minimal3dp-og-1200x630.png">
  <meta name="twitter:title" content="M3DP Tools">
  <meta name="twitter:description" content="Minimal 3DP Tools and Helper Scripts - A Work in Progress
Launched - 2025-11-08">
<link href="/scss/main.css" rel="stylesheet">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"></span><span class="navbar-brand__name">Minimal 3DP</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/about/"><span>About</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/blog/"><span>Blog</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/projects/"><span>Projects</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/klipper-calibration/"><span>Klipper Calibration</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/tools/"><span>M3DP Tools</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search">
  <div class="td-search__icon"></div>
  <input type="search" class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete="off">
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/tools/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">M3DP Tools</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-17f852d0ecc83d91afe54f19297f2ff0">3D Print Cost Calculator</a></li>


    
  
    
    
	
<li>2: <a href="#pg-4c42dc3209f6e4052e69c9952bc249f2">3D Print Shinkage Calculator</a></li>


    
  

    </ul>


<div class="content">
      

<div class="pageinfo pageinfo-primary">
<p>Minimal 3DP Tools and Helper Scripts - A Work in Progress</p>

</div>

<p>Launched - 2025-11-08</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-17f852d0ecc83d91afe54f19297f2ff0">1 - 3D Print Cost Calculator</h1>
    <div class="lead">Calculate the cost of 3D printing with FDM technology.</div>
	
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3DP FDM 3D Print Cost Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Light gray background */
        }

        /* Custom tooltip style */
        .info-icon {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            background-color: #9ca3af;
            /* gray-400 */
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 0.75rem;
            line-height: 1rem;
            font-weight: bold;
            font-style: normal;
            cursor: help;
            margin-left: 4px;
            position: relative;
        }

        /* Tooltip text - hidden by default */
        .info-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            /* Position above the icon */
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            /* gray-800 */
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.25;
            white-space: normal;
            width: 320px;
            /* Fixed width for better readability */
            text-align: left;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
        }

        /* Show tooltip on hover */
        .info-icon:hover::after {
            visibility: visible;
            opacity: 1;
        }

        /* Custom style for the sticky summary box */
        .sticky-summary {
            position: sticky;
            top: 6rem;
            /* 96px - Increased to prevent overlap with site header on scroll */
            align-self: start;
            /* Prevents stretching to grid height */
            z-index: 10;
            /* Ensure proper stacking order */
        }

        /* Style for the material info boxes */
        .material-info {
            background-color: #f9fafb;
            /* gray-50 */
            border: 1px solid #e5e7eb;
            /* gray-200 */
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        /* Pie Chart */
        #pie-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            /* Conic gradient will be set by JS */
            background-image: conic-gradient(#3b82f6 0% 0%,
                    /* Material (Blue) */
                    #10b981 0% 0%,
                    /* Labor (Green) */
                    #f59e0b 0% 0%,
                    /* Machine (Amber) */
                    #ef4444 0% 0%,
                    /* Tooling (Red) */
                    #8b5cf6 0% 0%
                    /* Finishing (Violet) */
                );
            border: 2px solid #e5e7eb;
        }

        /* Quote Modal */
        #quote-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Print styles - Not used since we open a new window */
        @media print {
            @page {
                size: letter;
                margin: 0.5in;
            }
        }

        /* Collapsible reference sections */
        details summary {
            cursor: pointer;
            font-weight: 500;
            color: #1f2937;
            /* gray-800 */
            padding: 8px;
            background-color: #f9fafb;
            /* gray-50 */
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        details summary:hover {
            background-color: #f3f4f6;
            /* gray-100 */
        }

        details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        details>div {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            /* gray-200 */
            border-top: none;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }
    </style>
</head>

<body class="h-full bg-gray-100 p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto max-w-7xl">

        <!-- Header -->
        <header class="mb-6">


            <h1 class="text-3xl font-bold text-gray-900">
                <a href="https://minimal3dp.com" target="_blank" rel="noopener noreferrer"
                    class="text-blue-600 hover:underline">
                    M3DP FDM 3D Print Cost Calculator
                </a>
            </h1>
            <p class="mt-1 text-lg text-gray-600">A comprehensive tool based on the Seregi & Ficzere (2025) cost model,
                expanded for business and hobbyist quoting.</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Column 1: Input Forms -->
            <div class="flex flex-col gap-6">

                <!-- Save/Load Profile -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="save_profile"
                            class="flex-1 bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Save All Settings
                        </button>
                        <button id="load_profile"
                            class="flex-1 bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            Load All Settings
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center">Saves/Loads all calculator inputs including job parameters, materials, machine settings, and pricing.</p>
                </div>

                <!-- Currency Selection -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Currency</h2>
                    <div>
                        <label for="currency_selector" class="block text-sm font-medium text-gray-700 mb-2">
                            Select Currency Symbol
                            <span class="info-icon"
                                data-tooltip="Choose the currency symbol to display in all pricing fields. This is display-only and does not perform currency conversion.">i</span>
                        </label>
                        <select id="currency_selector"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="USD" selected>$ - US Dollar (USD)</option>
                            <option value="GBP">£ - British Pound (GBP)</option>
                            <option value="EUR">€ - Euro (EUR)</option>
                            <option value="JPY">¥ - Japanese Yen (JPY)</option>
                            <option value="CAD">C$ - Canadian Dollar (CAD)</option>
                            <option value="AUD">A$ - Australian Dollar (AUD)</option>
                            <option value="CHF">CHF - Swiss Franc</option>
                            <option value="CNY">¥ - Chinese Yuan (CNY)</option>
                            <option value="INR">₹ - Indian Rupee (INR)</option>
                            <option value="KRW">₩ - South Korean Won (KRW)</option>
                            <option value="MXN">MX$ - Mexican Peso (MXN)</option>
                            <option value="BRL">R$ - Brazilian Real (BRL)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-2">Note: This changes the display symbol only. All calculations remain the same - no currency conversion is performed.</p>
                    </div>
                </div>

                <!-- Card 1: Job Parameters -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">1. Job Parameters</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Quote Details -->
                        <div>
                            <label for="quote_customer" class="block text-sm font-medium text-gray-700">
                                Customer Name (Optional)
                            </label>
                            <input type="text" id="quote_customer" placeholder="e.g., Jane Doe"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="quote_part_name" class="block text-sm font-medium text-gray-700">
                                Part/Project Name (Optional)
                            </label>
                            <input type="text" id="quote_part_name" placeholder="e.g., Enclosure V3"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                        <div class="sm:col-span-2 border-t pt-4"></div>

                        <!-- Print Job Details -->
                        <div>
                            <label for="parts_per_program" class="block text-sm font-medium text-gray-700">
                                Parts Per Build Plate
                                <span class="info-icon"
                                    data-tooltip="The total number of identical parts printed on a single build plate.">i</span>
                            </label>
                            <input type="number" id="parts_per_program" value="1" min="1" step="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="number_of_plates" class="block text-sm font-medium text-gray-700">
                                Number of Build Plates
                                <span class="info-icon"
                                    data-tooltip="How many build plates you need to print for this job. Example: 8 plates × 64 parts/plate = 512 total parts. Costs are calculated per plate, then multiplied.">i</span>
                            </label>
                            <input type="number" id="number_of_plates" value="1" min="1" step="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="program_length_hr" class="block text-sm font-medium text-gray-700">
                                Print Time Per Plate (Hours)
                                <span class="info-icon"
                                    data-tooltip="Print duration for ONE build plate, in hours. From your slicer's estimate. (e.g., 4.5 for 4h 30m). Total job time = this × number of plates.">i</span>
                            </label>
                            <input type="number" id="program_length_hr" value="1" min="0" step="0.1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="support_material_g" class="block text-sm font-medium text-gray-700">
                                Support Material Per Plate (grams)
                                <span class="info-icon"
                                    data-tooltip="Mass of support material for ONE build plate, in grams. From your slicer. Enter 0 if no support is used. Total = this × number of plates.">i</span>
                            </label>
                            <input type="number" id="support_material_g" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="failure_rate" class="block text-sm font-medium text-gray-700">
                                Est. Failure Rate (%)
                                <span class="info-icon"
                                    data-tooltip="Amortizes the cost of failed prints across successful ones. A 5% rate means you expect 1 in 20 prints to fail, increasing the cost.">i</span>
                            </label>
                            <input type="number" id="failure_rate" value="5" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 2: Material & Labor -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">2. Material & Labor</h2>
                    
                    <!-- Number of Model Materials Selector -->
                    <div class="mb-4 pb-4 border-b">
                        <label for="num_model_materials" class="block text-sm font-medium text-gray-700 mb-2">
                            Number of Model Materials
                            <span class="info-icon"
                                data-tooltip="How many different filament types/colors for the model (not including supports). Multi-color prints or mixed materials like PETG + TPU. Most prints use 1-2 materials.">i</span>
                        </label>
                        <select id="num_model_materials"
                            class="block w-full max-w-xs rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="1">1 Material (Standard)</option>
                            <option value="2">2 Materials (Dual Color/Type)</option>
                            <option value="3">3 Materials (Triple Color/Type)</option>
                            <option value="4">4 Materials (Quad Color/Type)</option>
                            <option value="5">5 Materials</option>
                            <option value="6">6 Materials</option>
                        </select>
                    </div>

                    <!-- Model Materials Container (dynamically populated) -->
                    <div id="model_materials_container">
                        <!-- Material input groups will be inserted here by JavaScript -->
                    </div>

                    <!-- Support Material (Optional) -->
                    <div class="border-t pt-4 mt-4">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">Support Material (Optional)</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                            <div>
                                <label for="support_material_cost_kg" class="block text-sm font-medium text-gray-700">
                                    Support Material Cost ($/kg)
                                    <span class="info-icon"
                                        data-tooltip="The price you paid for a 1kg roll of your support filament. Enter 0 if no supports used.">i</span>
                                </label>
                                <input type="number" id="support_material_cost_kg" value="20" min="0"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="support_material_type" class="block text-sm font-medium text-gray-700">Support
                                    Material Type</label>
                                <select id="support_material_type"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <optgroup label="Soluble">
                                        <option value="1.25">PVA (1.25 g/cm³)</option>
                                        <option value="1.07">HIPS (1.07 g/cm³)</option>
                                    </optgroup>
                                    <optgroup label="Breakaway">
                                        <option value="1.24">PLA (1.24 g/cm³)</option>
                                        <option value="1.27">PETG (1.27 g/cm³)</option>
                                        <option value="1.04">ABS (1.04 g/cm³)</option>
                                        <option value="1.06">ASA (1.06 g/cm³)</option>
                                    </optgroup>
                                    <optgroup label="My Materials" id="support_material_custom_group">
                                        <!-- Custom materials added by JS -->
                                    </optgroup>
                                    <optgroup label="Other">
                                        <option value="custom">Add New Custom...</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div id="support_material_density_custom_wrapper" class="hidden sm:col-span-2">
                                <label for="support_material_density_custom"
                                    class="block text-sm font-medium text-gray-700">Custom Support Density (g/cm³)</label>
                                <input type="number" id="support_material_density_custom" value="1.24" min="0" step="0.01"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <!-- Support Material Info Box -->
                            <div id="support_material_info" class="material-info sm:col-span-2">
                                <!-- Content dynamically inserted by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Labor -->
                    <div class="border-t pt-4 mt-4">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">Labor Costs</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                            <div>
                                <label for="hourly_wage" class="block text-sm font-medium text-gray-700">
                                    Labor Rate ($/hour)
                                    <span class="info-icon"
                                        data-tooltip="Your hourly rate for all manual labor (prep, post-processing, finishing).">i</span>
                                </label>
                            </label>
                            <input type="number" id="hourly_wage" value="20" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="prep_slicing_time" class="block text-sm font-medium text-gray-700">
                                Slicing & Prep (min/build plate)
                                <span class="info-icon"
                                    data-tooltip="Time spent *per build plate* on file prep, model orientation, and slicer setup.">i</span>
                            </label>
                            <input type="number" id="prep_slicing_time" value="10" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="manual_labor_time" class="block text-sm font-medium text-gray-700">
                                Machine Setup (min/build plate)
                                <span class="info-icon"
                                    data-tooltip="Time spent *per build plate* on printer setup, part removal, and cleanup. (Eq 6)">i</span>
                            </label>
                            <input type="number" id="manual_labor_time" value="5" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                    </div>
                </div>

                <!-- Card 3: Custom Material Manager -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">3. My Material Library</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-1">
                            <label for="custom_material_name" class="block text-sm font-medium text-gray-700">Material
                                Name</label>
                            <input type="text" id="custom_material_name" placeholder="e.g., My CF-PC"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="sm:col-span-1">
                            <label for="custom_material_density" class="block text-sm font-medium text-gray-700">Density
                                (g/cm³)</label>
                            <input type="number" id="custom_material_density" placeholder="e.g., 1.28" min="0"
                                step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="sm:col-span-1 flex items-end">
                            <button id="save_custom_material"
                                class="w-full bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                Save Material
                            </button>
                        </div>
                    </div>
                    <div id="custom_material_list" class="mt-4 text-sm text-gray-600 space-y-1">
                        <!-- Saved materials will be listed here by JS -->
                    </div>
                </div>

                <!-- Card 4: Machine Operation -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">4. Machine Operation</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="printer_cost" class="block text-sm font-medium text-gray-700">
                                Printer Cost ($)
                                <span class="info-icon"
                                    data-tooltip="The total purchase price of your 3D printer. (e.g., Hobbyist: $200-$1,000; Professional: $3,000-$10,000+). Used for depreciation.">i</span>
                            </label>
                            <input type="number" id="printer_cost" value="1000"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="printer_lifespan_hr" class="block text-sm font-medium text-gray-700">
                                Printer Lifespan (hours)
                                <span class="info-icon"
                                    data-tooltip="Estimated total operational hours before the printer is fully depreciated (e.g., 20,000 hours).">i</span>
                            </label>
                            <input type="number" id="printer_lifespan_hr" value="20000" min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="maintenance_cost_hr" class="block text-sm font-medium text-gray-700">
                                Maintenance Cost ($/hour)
                                <span class="info-icon"
                                    data-tooltip="Cost of maintenance parts (belts, fans, etc.) amortized per hour. (e.g., $0.05 - $0.25). Hobbyist annual cost ($100-$200) / annual print hours.">i</span>
                            </label>
                            <input type="number" id="maintenance_cost_hr" value="0.10" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="machine_power_w" class="block text-sm font-medium text-gray-700">
                                Avg. Power (Watts)
                                <span class="info-icon"
                                    data-tooltip="Average power consumption of the printer in Watts. (e.g., Ender 3: ~120-150W, Prusa MK3: ~100-130W).">i</span>
                            </label>
                            <input type="number" id="machine_power_w" value="130" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="electricity_cost_kwh" class="block text-sm font-medium text-gray-700">
                                Electricity Cost ($/kWh)
                                <span class="info-icon"
                                    data-tooltip="Your local electricity rate in dollars per kilowatt-hour. (e.g., $0.15)">i</span>
                            </label>
                            <input type="number" id="electricity_cost_kwh" value="0.15" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 5: Tooling -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">5. Tooling (Eq 5)</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Build Plate -->
                        <div>
                            <label for="build_plate_cost" class="block text-sm font-medium text-gray-700">
                                Build Plate Cost ($)
                                <span class="info-icon"
                                    data-tooltip="Cost of your PEI, Glass, or other build plate.">i</span>
                            </label>
                            <input type="number" id="build_plate_cost" value="30" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="build_plate_lifespan_hr" class="block text-sm font-medium text-gray-700">
                                Build Plate Lifespan (hours)
                                <span class="info-icon"
                                    data-tooltip="Estimated total lifespan in print hours (e.g., PEI/Glass: 5000+).">i</span>
                            </label>
                            <input type="number" id="build_plate_lifespan_hr" value="5000" min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                        <!-- Model Nozzle -->
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="model_nozzle_cost" class="block text-sm font-medium text-gray-700">
                                Model Nozzle Cost ($)
                                <span class="info-icon"
                                    data-tooltip="Cost of the nozzle for the model material. (e.g., Brass: $2, Hardened Steel: $15)">i</span>
                            </label>
                            <input type="number" id="model_nozzle_cost" value="2" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="model_nozzle_lifespan_kg" class="block text-sm font-medium text-gray-700">
                                Model Nozzle Lifespan (kg)
                                <span class="info-icon"
                                    data-tooltip="Estimated filament mass (in kg) this nozzle can print. See guide below. (e.g., Brass/PLA: 25kg, Brass/CF: 0.5kg)">i</span>
                            </label>
                            <input type="number" id="model_nozzle_lifespan_kg" value="25" min="0.1" step="0.1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                        <!-- Support Nozzle -->
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="support_nozzle_cost" class="block text-sm font-medium text-gray-700">
                                Support Nozzle Cost ($)
                                <span class="info-icon"
                                    data-tooltip="Cost of the nozzle for the support material. (If same as model, enter 0 and use model nozzle fields)">i</span>
                            </label>
                            <input type="number" id="support_nozzle_cost" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="support_nozzle_lifespan_kg" class="block text-sm font-medium text-gray-700">
                                Support Nozzle Lifespan (kg)
                                <span class="info-icon"
                                    data-tooltip="Estimated filament mass (in kg) this nozzle can print. (Only if using a separate nozzle for support)">i</span>
                            </label>
                            <input type="number" id="support_nozzle_lifespan_kg" value="25" min="0.1" step="0.1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 6: Finishing & Post-Processing (Optional) -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">6. Finishing & Post-Processing
                        (Optional)</h2>

                    <!-- Mechanical Finishing -->
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Mechanical Finishing</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="finishing_labor_time_part" class="block text-sm font-medium text-gray-700">
                                Finishing Labor (min/part)
                                <span class="info-icon"
                                    data-tooltip="Time spent *per part* on sanding, painting, etc. Example: 5 minutes per part for sanding.">i</span>
                            </label>
                            <input type="number" id="finishing_labor_time_part" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="finishing_labor_time_plate" class="block text-sm font-medium text-gray-700">
                                Finishing Labor (min/plate)
                                <span class="info-icon"
                                    data-tooltip="Time spent *per build plate* on handling, packing, quality control, etc., regardless of part count. Example: 10 minutes for packing entire plate.">i</span>
                            </label>
                            <input type="number" id="finishing_labor_time_plate" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="finishing_materials_cost" class="block text-sm font-medium text-gray-700">
                                Finishing Materials ($/build plate)
                                <span class="info-icon"
                                    data-tooltip="Cost of non-filament materials *per build plate* (primer, paint, glue, screws).">i</span>
                            </label>
                            <input type="number" id="finishing_materials_cost" value="0" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <!-- Chemical Post-Processing -->
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Chemical Post-Processing (Eq 2)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="solvent_cost_liter" class="block text-sm font-medium text-gray-700">
                                Solvent Cost ($/Liter)
                                <span class="info-icon"
                                    data-tooltip="Cost per liter of your solvent (e.g., D-Limonene for HIPS, Water for PVA). 1 Liter = 1000 cm³">i</span>
                            </label>
                            <input type="number" id="solvent_cost_liter" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="solving_time_hr" class="block text-sm font-medium text-gray-700">
                                Solving Time (hours)
                                <span class="info-icon"
                                    data-tooltip="Time the part spends in the solvent bath.">i</span>
                            </label>
                            <input type="number" id="solving_time_hr" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="tank_power_w" class="block text-sm font-medium text-gray-700">
                                Tank Power (Watts)
                                <span class="info-icon"
                                    data-tooltip="Average power consumption of the solvent tank (heater, stirrer).">i</span>
                            </label>
                            <input type="number" id="tank_power_w" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 7: Markup -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">7. Markup (Optional)</h2>
                    
                    <!-- Markup Type Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Markup Type</label>
                        <div class="flex gap-6">
                            <label class="inline-flex items-center">
                                <input type="radio" name="markup_type" value="percent" checked
                                    class="form-radio h-4 w-4 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Percentage (%)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="markup_type" value="flat"
                                    class="form-radio h-4 w-4 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Flat Dollar Amount ($)</span>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Percentage Markup -->
                        <div id="markup_percent_wrapper">
                            <label for="markup_percent" class="block text-sm font-medium text-gray-700">
                                Overhead & Profit Markup (%)
                                <span class="info-icon"
                                    data-tooltip="A percentage markup applied to the total cost per part for business overhead and profit. (e.g., 50 for 50%)">i</span>
                            </label>
                            <input type="number" id="markup_percent" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                        <!-- Flat Dollar Markup -->
                        <div id="markup_flat_wrapper" style="display: none;">
                            <label for="markup_flat_dollar" class="block text-sm font-medium text-gray-700">
                                Flat Markup Amount ($)
                                <span class="info-icon"
                                    data-tooltip="A fixed dollar amount added to the total cost per build plate. Useful when you've agreed on a specific markup with your client. (e.g., 50)">i</span>
                            </label>
                            <input type="number" id="markup_flat_dollar" value="0" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Reference Guides (Collapsible) -->
                <div class="bg-white rounded-lg shadow-md p-6 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Reference Guides</h2>

                    <!-- Nozzle Lifespan Guide -->
                    <details>
                        <summary class="text-lg">Nozzle Lifespan Reference Guide</summary>
                        <div class="space-y-4">
                            <p class="text-sm text-gray-600">Nozzle lifespan depends on the nozzle material and the
                                filament being printed. Abrasive filaments (carbon fiber, glow-in-the-dark, wood-fill)
                                will destroy brass nozzles very quickly.</p>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Nozzle Material
                                            </th>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Filament Type</th>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Est. Lifespan (kg)
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td class="px-4 py-2 font-medium">Brass</td>
                                            <td class="px-4 py-2">Standard (PLA, ABS, PETG)</td>
                                            <td class="px-4 py-2">10 - 25 kg+</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">Brass</td>
                                            <td class="px-4 py-2 text-red-600">Abrasive (CF, Wood, Glow)</td>
                                            <td class="px-4 py-2 text-red-600">&lt; 1 kg (as low as 0.25 kg)</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">Stainless Steel</td>
                                            <td class="px-4 py-2">Standard & Light Abrasive</td>
                                            <td class="px-4 py-2">20 - 50 kg+</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">Hardened Steel</td>
                                            <td class="px-4 py-2">All, incl. Heavy Abrasive</td>
                                            <td class="px-4 py-2">50 - 100 kg+</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">Ruby / Nozzle X</td>
                                            <td class="px-4 py-2">All, incl. Heavy Abrasive</td>
                                            <td class="px-4 py-2">100 kg++</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </details>

                    <!-- Nozzle Size Guide -->
                    <details>
                        <summary class="text-lg">Nozzle Size Reference Guide</summary>
                        <div class="space-y-4">
                            <p class="text-sm text-gray-600">Nozzle diameter (size) is a trade-off between print speed
                                and detail.</p>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Nozzle Size (mm)
                                            </th>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Typical Use Case
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td class="px-4 py-2 font-medium">0.15 - 0.25</td>
                                            <td class="px-4 py-2">Extreme detail (e.g., miniatures), very slow. Prone to
                                                clogging.</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">0.40 (Standard)</td>
                                            <td class="px-4 py-2">Best all-around balance of speed and detail. Default
                                                on most printers.</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">0.60</td>
                                            <td class="px-4 py-2">Faster prints, stronger parts. Good for abrasive
                                                filaments. Loses fine detail.</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 font-medium">0.80 - 1.00+</td>
                                            <td class="px-4 py-2">Very fast "draft" prints or large structural parts.
                                                Very low detail.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- Footer / References -->
                <footer class="mt-4 text-gray-600 text-xs">
                    <h3 class="font-semibold text-gray-700 mb-2">References</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>
                            Seregi, B.L.; Ficzere, P. (2025). Refined Cost Calculation Framework for FDM Parts.
                            <a href="https://www.mdpi.com/2504-4494/9/9/321" target="_blank" rel="noopener noreferrer"
                                class="text-blue-600 hover:underline">
                                jmmp-09-00321
                            </a>
                        </li>
                        <li>
                            Simplify3D (n.d.). Filament Properties Table.
                            <a href="https://www.simplify3d.com/resources/materials-guide/properties-table/"
                                target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                                simplify3d.com
                            </a>
                        </li>
                        <li>
                            Nozzle material & lifespan guides (All3DP, Sovol, Creality, 3DJake, etc.)
                        </li>
                        <li>
                            Build plate guides (All3DP, Bambu Lab Forum, Reddit, etc.)
                        </li>
                        <li>
                            Fusion3 Design (n.d.). How Much Does a 3D Printer Cost?
                            <a href="https://www.fusion3design.com/how-much-does-a-3d-printer-cost/" target="_blank"
                                rel="noopener noreferrer" class="text-blue-600 hover:underline">
                                fusion3design.com
                            </a>
                        </li>
                        <li>
                            Machine maintenance guides (EufyMake, Raise3D, Qidi, etc.)
                        </li>
                    </ul>
                </footer>

            </div> <!-- End Column 1 -->

            <!-- Column 2: Cost Summary (Sticky) -->
            <div class="sticky-summary">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-900 border-b pb-3 mb-4">Cost Summary</h2>

                    <!-- Main Display Box -->
                    <div class="bg-blue-600 text-white rounded-lg p-6 mb-4 text-center">
                        <label class="block text-sm font-medium text-blue-200">Final Quoted Price (per Part)</label>
                        <div id="summary_final_quote" class="text-5xl font-bold tracking-tight">
                            $0.00
                        </div>
                        <div id="summary_total_cost_per_part" class="text-sm text-blue-100 opacity-80 mt-1">
                            ($0.00 base cost + $0.00 markup)
                        </div>
                    </div>

                    <!-- Generate Quote Button -->
                    <button id="generate_quote_btn"
                        class="w-full bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 mb-4">
                        Generate Printable Quote
                    </button>

                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center text-sm font-medium text-gray-600">
                            <span>Total Job Cost (<span id="summary_parts_count_1">1</span> parts):</span>
                            <span id="summary_total_build_plate_cost" class="text-gray-900 font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-500 mt-1">
                            <span>Cost per Part:</span>
                            <span id="summary_base_cost_per_part" class="text-gray-700">$0.00</span>
                        </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Cost Breakdown (per Build Plate)</h3>

                    <!-- Pie Chart & Legend -->
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                        <div id="pie-chart" class="flex-shrink-0"></div>
                        <div id="pie-legend" class="text-sm space-y-1 w-full">
                            <!-- Legend items inserted by JS -->
                            <div class="flex items-center justify-between">
                                <div><span class="inline-block w-3 h-3 rounded-full mr-2"
                                        style="background-color: #3b82f6;"></span>Material</div>
                                <div id="legend_material" class="font-medium">$0.00 (0%)</div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div><span class="inline-block w-3 h-3 rounded-full mr-2"
                                        style="background-color: #10b981;"></span>Labor</div>
                                <div id="legend_labor" class="font-medium">$0.00 (0%)</div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div><span class="inline-block w-3 h-3 rounded-full mr-2"
                                        style="background-color: #f59e0b;"></span>Machine</div>
                                <div id="legend_machine" class="font-medium">$0.00 (0%)</div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div><span class="inline-block w-3 h-3 rounded-full mr-2"
                                        style="background-color: #ef4444;"></span>Tooling</div>
                                <div id="legend_tooling" class="font-medium">$0.00 (0%)</div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div><span class="inline-block w-3 h-3 rounded-full mr-2"
                                        style="background-color: #8b5cf6;"></span>Finishing</div>
                                <div id="legend_finishing" class="font-medium">$0.00 (0%)</div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2 text-sm">
                        <!-- Material -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">1. Material Cost</span>
                            <span id="summary_material_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Labor -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">2. Labor Cost</span>
                            <span id="summary_labor_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Machine -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">3. Machine Operation</span>
                            <span id="summary_machine_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Tooling -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">4. Tooling</span>
                            <span id="summary_tooling_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Finishing -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">5. Finishing & Post-Processing</span>
                            <span id="summary_post_processing_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <div class="border-t my-2"></div>
                        <!-- Subtotal -->
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-800">Subtotal (Base Cost)</span>
                            <span id="summary_subtotal_cost" class="font-bold text-gray-900">$0.00</span>
                        </div>
                        <!-- Failure Rate -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">Failure Rate Markup (<span
                                    id="summary_failure_rate">5</span>%)</span>
                            <span id="summary_failure_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Total -->
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-800">Total Build Plate Cost</span>
                            <span id="summary_total_cost" class="font-bold text-gray-900">$0.00</span>
                        </div>
                    </div>

                    <!-- Quick Metrics -->
                    <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-2">Quick Metrics</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Print Time</span>
                            <span id="summary_total_time" class="font-medium text-gray-900">1.00 hr</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Mass</span>
                            <span id="summary_total_mass" class="font-medium text-gray-900">10 g</span>
                        </div>
                        <div class="border-t my-2"></div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Cost per Print Hour</span>
                            <span id="summary_cost_per_hour" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Cost per Gram</span>
                            <span id="summary_cost_per_gram" class="font-medium text-gray-900">$0.00</span>
                        </div>
                    </div>

                    <!-- Message Box -->
                    <div id="message_box" class="hidden mt-4 p-3 rounded-md text-sm">
                        <!-- Messages inserted here -->
                    </div>

                </div>
            </div> <!-- End Column 2 -->
        </div> <!-- End Main Grid -->
    </div> <!-- End Container -->

    <!-- Quote Modal -->
    <div id="quote-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <!-- Backdrop -->
        <div id="quote-modal-backdrop" class="fixed inset-0"></div>

        <!-- Modal Content -->
        <div id="quote-modal-content"
            class="bg-white rounded-lg shadow-2xl z-10 w-full max-w-2xl border border-gray-300 max-h-[90vh] flex flex-col">
            <div id="quote-modal-header" class="flex justify-between items-center p-4 border-b flex-shrink-0">
                <h2 class="text-xl font-semibold text-gray-800">Print Job Quote</h2>
                <div class="flex gap-2 items-center">
                    <button id="quote-modal-print-top"
                        class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Print Quote
                    </button>
                    <button id="quote-modal-close" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="p-8 overflow-y-auto flex-grow">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900">Quote</h3>
                        <p class="text-sm text-gray-500">Generated: <span id="quote_date">--</span></p>
                    </div>
                    <div class="text-right">
                        <h4 class="text-lg font-semibold text-gray-700">From:</h4>
                        <p class="text-gray-600">My 3D Printing Service</p>
                        <!-- You can add more 'From' details here -->
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">To:</h4>
                    <p id="quote_customer_name" class="text-gray-600">N/A</p>
                </div>

                <h4 class="text-lg font-semibold text-gray-700 mb-2">Project Details:</h4>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-6 py-3 text-sm font-medium text-gray-500 whitespace-nowrap">Part/Project
                                    Name</td>
                                <td id="quote_part_name_val" class="px-6 py-3 text-sm text-gray-900 font-medium">--</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 text-sm font-medium text-gray-500 whitespace-nowrap">Model Material
                                </td>
                                <td id="quote_material_val" class="px-6 py-3 text-sm text-gray-900">--</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 text-sm font-medium text-gray-500 whitespace-nowrap">Est. Print
                                    Time</td>
                                <td id="quote_time_val" class="px-6 py-3 text-sm text-gray-900">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Pricing:</h4>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Item</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Quantity</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Price per Part</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td id="quote_item_name" class="px-6 py-4 text-sm font-medium text-gray-900">--</td>
                                <td id="quote_quantity_val" class="px-6 py-4 text-sm text-gray-700 text-right">--</td>
                                <td id="quote_price_per_val" class="px-6 py-4 text-sm text-gray-700 text-right">--</td>
                                <td id="quote_total_val" class="px-6 py-4 text-sm font-medium text-gray-900 text-right">
                                    --</td>
                            </tr>
                        </tbody>
                        <tfoot class="bg-gray-50">
                            <tr>
                                <td colspan="3" class="px-6 py-3 text-right text-sm font-bold text-gray-800 uppercase">
                                    Grand Total</td>
                                <td id="quote_grand_total_val"
                                    class="px-6 py-3 text-right text-sm font-bold text-gray-900">--</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="mt-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Notes:</h4>
                    <textarea id="quote_notes_input"
                        class="w-full h-24 p-2 border rounded-md text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., Estimated lead time: 3-5 business days. Price valid for 30 days."></textarea>
                </div>
            </div>

            <div id="quote-modal-footer" class="flex justify-end items-center p-4 bg-gray-50 border-t rounded-b-lg flex-shrink-0">
                <button id="quote-modal-print"
                    class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Print Quote
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA & CONSTANTS ---

            // Data from Simplify3D Properties Table
            const materialProperties = {
                '1.24': { // PLA
                    name: 'PLA',
                    density: 1.24,
                    extruderTemp: '190-230 °C',
                    bedTemp: '20-60 °C',
                    surface: 'Blue painter\'s tape, glue stick, PEI sheet'
                },
                '1.27': { // PETG
                    name: 'PETG',
                    density: 1.27,
                    extruderTemp: '220-250 °C',
                    bedTemp: '50-75 °C',
                    surface: 'Blue painter\'s tape, PEI sheet (w/ glue stick as release agent)'
                },
                '1.04': { // ABS
                    name: 'ABS',
                    density: 1.04,
                    extruderTemp: '210-250 °C',
                    bedTemp: '80-110 °C',
                    surface: 'Kapton tape, ABS slurry, PEI sheet'
                },
                '1.06': { // ASA
                    name: 'ASA',
                    density: 1.06,
                    extruderTemp: '240-260 °C',
                    bedTemp: '90-110 °C',
                    surface: 'Kapton tape, PEI sheet'
                },
                '1.20': { // TPU/TPE
                    name: 'TPU/TPE',
                    density: 1.20,
                    extruderTemp: '210-230 °C',
                    bedTemp: '20-60 °C',
                    surface: 'Blue painter\'s tape, glue stick'
                },
                '1.08': { // Nylon (PA)
                    name: 'Nylon (PA)',
                    density: 1.08,
                    extruderTemp: '240-260 °C',
                    bedTemp: '70-90 °C',
                    surface: 'Garolite sheet, glue stick on glass'
                },
                '1.21': { // Polycarbonate (PC)
                    name: 'Polycarbonate (PC)',
                    density: 1.20,
                    extruderTemp: '270-310 °C',
                    bedTemp: '90-110 °C',
                    surface: 'Garolite sheet, PEI sheet with glue stick'
                },
                'custom': {
                    name: 'Custom',
                    density: null, // Will be user-defined
                    extruderTemp: 'N/A',
                    bedTemp: 'N/A',
                    surface: 'Refer to manufacturer'
                },
                // Support-specific materials
                '1.25': { // PVA
                    name: 'PVA',
                    density: 1.25,
                    extruderTemp: '190-220 °C',
                    bedTemp: '20-60 °C',
                    surface: 'Blue painter\'s tape, PEI sheet (dissolves in water)'
                },
                '1.07': { // HIPS
                    name: 'HIPS',
                    density: 1.07,
                    extruderTemp: '220-240 °C',
                    bedTemp: '90-110 °C',
                    surface: 'Kapton tape, PEI (dissolves in D-Limonene)'
                }
            };


            // --- DOM Elements ---
            const allInputs = document.querySelectorAll('input, select');
            const messageBox = document.getElementById('message_box');
            const saveProfileButton = document.getElementById('save_profile');
            const loadProfileButton = document.getElementById('load_profile');
            const saveMaterialButton = document.getElementById('save_custom_material');
            const pieChartEl = document.getElementById('pie-chart');

            // Quote Modal Elements
            const quoteModal = document.getElementById('quote-modal');
            const quoteModalCloseBtn = document.getElementById('quote-modal-close');
            const quoteModalBackdrop = document.getElementById('quote-modal-backdrop');
            const generateQuoteBtn = document.getElementById('generate_quote_btn');
            const printQuoteBtn = document.getElementById('quote-modal-print');

            // --- Storage Availability Check ---
            let storageAvailable = false;
            try {
                const testKey = 'fdm_calc_storage_test';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                storageAvailable = true;
            } catch (e) {
                storageAvailable = false;
                console.warn("LocalStorage is not available. Profile/Material saving may not work.");
            }

            const CUSTOM_MATERIALS_KEY = 'fdmCustomMaterials';
            let lastCalculatedCosts = {}; // Store results for the quote modal

            // Currency configuration
            const currencyConfig = {
                'USD': { symbol: '$', code: 'USD', locale: 'en-US' },
                'GBP': { symbol: '£', code: 'GBP', locale: 'en-GB' },
                'EUR': { symbol: '€', code: 'EUR', locale: 'en-EU' },
                'JPY': { symbol: '¥', code: 'JPY', locale: 'ja-JP' },
                'CAD': { symbol: 'C$', code: 'CAD', locale: 'en-CA' },
                'AUD': { symbol: 'A$', code: 'AUD', locale: 'en-AU' },
                'CHF': { symbol: 'CHF', code: 'CHF', locale: 'de-CH' },
                'CNY': { symbol: '¥', code: 'CNY', locale: 'zh-CN' },
                'INR': { symbol: '₹', code: 'INR', locale: 'en-IN' },
                'KRW': { symbol: '₩', code: 'KRW', locale: 'ko-KR' },
                'MXN': { symbol: 'MX$', code: 'MXN', locale: 'es-MX' },
                'BRL': { symbol: 'R$', code: 'BRL', locale: 'pt-BR' }
            };

            // --- HELPER FUNCTIONS ---

            /**
             * Gets the numeric value from an input field.
             * @param {string} id - The ID of the input element.
             * @returns {number} The parsed float value, or 0 if invalid.
             */
            function getVal(id) {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`Element with ID ${id} not found.`);
                    return 0;
                }
                const val = parseFloat(el.value);
                return isNaN(val) ? 0 : val;
            }

            /**
             * Gets the string value from an input field.
             * @param {string} id - The ID of the input element.
             * @returns {string} The value.
             */
            function getStr(id) {
                const el = document.getElementById(id);
                return el ? el.value : '';
            }

            /**
             * Gets the currently selected currency configuration.
             * @returns {Object} The currency config object with symbol, code, and locale.
             */
            function getCurrentCurrency() {
                const currencySelect = document.getElementById('currency_selector');
                const selectedCode = currencySelect ? currencySelect.value : 'USD';
                return currencyConfig[selectedCode] || currencyConfig['USD'];
            }

            /**
             * Formats a number as a currency string using the selected currency.
             * @param {number} num - The number to format.
             * @returns {string} The formatted currency string (e.g., "$1.23" or "£1.23").
             */
            function formatCurrency(num) {
                if (isNaN(num)) {
                    const currency = getCurrentCurrency();
                    return `${currency.symbol}0.00`;
                }
                
                const currency = getCurrentCurrency();
                
                // Use Intl.NumberFormat for proper currency formatting
                try {
                    const formatter = new Intl.NumberFormat(currency.locale, {
                        style: 'currency',
                        currency: currency.code,
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    return formatter.format(num);
                } catch (e) {
                    // Fallback to simple formatting if locale is not supported
                    return `${currency.symbol}${num.toFixed(2)}`;
                }
            }

            /**
             * Formats a number to a fixed number of decimal places.
             * @param {number} num - The number to format.
             * @param {number} places - The number of decimal places.
             * @returns {string} The formatted number string.
             */
            function formatNum(num, places = 2) {
                if (isNaN(num)) return (0).toFixed(places);
                return num.toFixed(places);
            }

            /**
             * Displays a message to the user.
             * @param {string} text - The message text.
             * @param {'success' | 'error' | 'warn'} type - The message type.
             */
            function showMessage(text, type = 'success') {
                if (!messageBox) return; // Guard clause
                messageBox.textContent = text;
                if (type === 'success') {
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-green-100 text-green-800';
                } else if (type === 'error') {
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-red-100 text-red-800';
                } else { // 'warn'
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-yellow-100 text-yellow-800';
                }
                messageBox.classList.remove('hidden');

                // Hide message after 3 seconds, unless it's the storage warning
                if (text.includes('Browser storage')) return;

                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            }

            /**
             * Toggles the visibility of the custom density input.
             * @param {string} selectId - The ID of the material <select> element.
             * @param {string} wrapperId - The ID of the custom density wrapper <div>.
             */
            function toggleCustomDensity(selectId, wrapperId) {
                const select = document.getElementById(selectId);
                const wrapper = document.getElementById(wrapperId);
                if (!select || !wrapper) return;
                if (select.value === 'custom') {
                    wrapper.classList.remove('hidden');
                } else {
                    wrapper.classList.add('hidden');
                }
            }

            /**
             * Toggles between percentage and flat dollar markup options.
             */
            function toggleMarkupType() {
                const markupType = document.querySelector('input[name="markup_type"]:checked');
                const percentWrapper = document.getElementById('markup_percent_wrapper');
                const flatWrapper = document.getElementById('markup_flat_wrapper');
                
                if (!markupType || !percentWrapper || !flatWrapper) return;
                
                if (markupType.value === 'percent') {
                    percentWrapper.style.display = 'block';
                    flatWrapper.style.display = 'none';
                } else {
                    percentWrapper.style.display = 'none';
                    flatWrapper.style.display = 'block';
                }
            }

            /**
             * Gets the density for a selected material.
             * @param {string} typeSelectId - The ID of the material type dropdown.
             * @param {string} customInputId - The ID of the custom density input.
             * @returns {number} The density in g/cm³. Always returns a value > 0 to prevent division by zero.
             */
            function getDensity(typeSelectId, customInputId) {
                const typeVal = getStr(typeSelectId);
                let density = 0;
                
                if (typeVal === 'custom') {
                    density = getVal(customInputId);
                } else if (materialProperties[typeVal]) {
                    // Check standard properties
                    density = materialProperties[typeVal].density;
                } else if (typeVal.includes('_')) {
                    // Check custom materials (value will be density_name)
                    density = parseFloat(typeVal.split('_')[0]);
                }

                // Validation: Ensure density is positive, default to PLA density if invalid
                // This prevents division by zero errors in volume calculations
                if (isNaN(density) || density <= 0) {
                    console.warn(`Invalid density value (${density}). Defaulting to PLA density (1.24 g/cm³)`);
                    return 1.24;
                }

                return density;
            }

            /**
             * Gets the name for a selected material.
             * @param {string} typeSelectId - The ID of the material type dropdown.
             * @returns {string} The material name.
             */
            function getMaterialName(typeSelectId) {
                const select = document.getElementById(typeSelectId);
                if (!select) return "N/A";

                const typeVal = select.value;

                // Check standard properties
                if (materialProperties[typeVal]) {
                    return materialProperties[typeVal].name;
                }

                // Check custom materials (value will be density_name)
                if (typeVal.includes('_')) {
                    return typeVal.split('_')[1];
                }

                return "N/A";
            }

            /**
             * Generates material input groups dynamically based on number selected.
             * @param {number} numMaterials - Number of materials to generate (1-6).
             */
            function generateMaterialGroups(numMaterials) {
                const container = document.getElementById('model_materials_container');
                if (!container) return;

                // Clear existing content
                container.innerHTML = '';

                // Generate material groups
                for (let i = 1; i <= numMaterials; i++) {
                    const materialHTML = `
                        <div class="material-group border-b pb-4 mb-4" data-material-index="${i}">
                            <h3 class="text-lg font-medium text-gray-700 mb-3">Material ${i}${i === 1 ? ' (Primary)' : ''}</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 gap-y-4">
                                <!-- Material mass -->
                                <div>
                                    <label for="material_${i}_mass_g" class="block text-sm font-medium text-gray-700">
                                        Mass Per Plate (grams)
                                        <span class="info-icon"
                                            data-tooltip="Grams of this material/color used for ONE build plate. From your slicer.">i</span>
                                    </label>
                                    <input type="number" id="material_${i}_mass_g" value="${i === 1 ? '10' : '0'}" min="0"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <!-- Material cost -->
                                <div>
                                    <label for="material_${i}_cost_kg" class="block text-sm font-medium text-gray-700">
                                        Cost ($/kg)
                                        <span class="info-icon"
                                            data-tooltip="Price per kilogram for this filament.">i</span>
                                    </label>
                                    <input type="number" id="material_${i}_cost_kg" value="20" min="0"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <!-- Material type -->
                                <div>
                                    <label for="material_${i}_type" class="block text-sm font-medium text-gray-700">
                                        Material Type
                                    </label>
                                    <select id="material_${i}_type"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                        <optgroup label="Common">
                                            <option value="1.24" ${i === 1 ? 'selected' : ''}>PLA (1.24 g/cm³)</option>
                                            <option value="1.27">PETG (1.27 g/cm³)</option>
                                            <option value="1.04">ABS (1.04 g/cm³)</option>
                                            <option value="1.06">ASA (1.06 g/cm³)</option>
                                        </optgroup>
                                        <optgroup label="Engineering/Flexible">
                                            <option value="1.20">TPU/TPE (1.20 g/cm³)</option>
                                            <option value="1.08">Nylon (PA) (1.08 g/cm³)</option>
                                            <option value="1.21">Polycarbonate (PC) (1.20 g/cm³)</option>
                                        </optgroup>
                                        <optgroup label="Other">
                                            <option value="custom">Add New Custom...</option>
                                        </optgroup>
                                    </select>
                                </div>

                                <!-- Custom density input (hidden by default) -->
                                <div id="material_${i}_density_custom_wrapper" class="hidden sm:col-span-3">
                                    <label for="material_${i}_density_custom"
                                        class="block text-sm font-medium text-gray-700">Custom Density (g/cm³)</label>
                                    <input type="number" id="material_${i}_density_custom" value="1.24" min="0" step="0.01"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <!-- Material info box -->
                                <div id="material_${i}_info" class="material-info sm:col-span-3">
                                    <!-- Content dynamically inserted by JS -->
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', materialHTML);

                    // Add event listeners for this material
                    setTimeout(() => {
                        const typeSelect = document.getElementById(`material_${i}_type`);
                        if (typeSelect) {
                            typeSelect.addEventListener('input', () => {
                                toggleCustomDensity(`material_${i}_type`, `material_${i}_density_custom_wrapper`);
                                updateMaterialInfo(`material_${i}_type`, `material_${i}_info`);
                            });
                            // Trigger initial update
                            updateMaterialInfo(`material_${i}_type`, `material_${i}_info`);
                        }

                        // Add to allInputs for calculation recalc
                        const massInput = document.getElementById(`material_${i}_mass_g`);
                        const costInput = document.getElementById(`material_${i}_cost_kg`);
                        const densityInput = document.getElementById(`material_${i}_density_custom`);
                        if (massInput) massInput.addEventListener('input', calculateCost);
                        if (costInput) costInput.addEventListener('input', calculateCost);
                        if (densityInput) densityInput.addEventListener('input', calculateCost);
                    }, 0);
                }
            }

            /**
             * Updates the material info box.
             * @param {string} selectId - The ID of the material <select> element.
             * @param {string} infoBoxId - The ID of the info box <div>.
             */
            function updateMaterialInfo(selectId, infoBoxId) {
                const select = document.getElementById(selectId);
                const infoBox = document.getElementById(infoBoxId);
                if (!select || !infoBox) return;
                const key = select.value;

                if (key === 'custom') {
                    infoBox.innerHTML = `<p class="text-gray-700">Please add a new custom material from the "My Material Library" card below, or temporarily enter a density if this is a one-time use.</p>`;
                    return;
                }

                let props;
                if (materialProperties[key]) {
                    props = materialProperties[key];
                } else if (key.includes('_')) {
                    // Custom material
                    const parts = key.split('_');
                    props = {
                        name: parts[1],
                        density: parseFloat(parts[0]),
                        extruderTemp: 'N/A',
                        bedTemp: 'N/A',
                        surface: 'Refer to manufacturer'
                    };
                } else {
                    infoBox.innerHTML = '';
                    return;
                }

                infoBox.innerHTML = `
                    <strong class="text-gray-900">${props.name} Properties:</strong>
                    <ul class="list-disc list-inside ml-1 text-gray-700 space-y-1 mt-1">
                        <li><strong>Density:</strong> ${props.density} g/cm³</li>
                        <li><strong>Extruder Temp:</strong> ${props.extruderTemp}</li>
                        <li><strong>Bed Temp:</strong> ${props.bedTemp}</li>
                        <li><strong>Build Surface:</strong> ${props.surface}</li>
                    </ul>
                `;
            }


            // --- MAIN CALCULATION ---

            function calculateCost() {
                // --- 1. Get All Input Values ---

                // Job Parameters
                const N_parts = getVal('parts_per_program'); // parts per plate
                const N_plates = getVal('number_of_plates'); // number of plates for job
                const t_program = getVal('program_length_hr'); // hours per plate
                const m_model_g = getVal('model_material_g'); // grams per plate
                const m_support_g = getVal('support_material_g'); // grams per plate
                const failure_rate = getVal('failure_rate') / 100; // as decimal

                // Material & Labor
                const p_model_kg = getVal('model_material_cost_kg'); // $/kg (used for legacy/fallback)
                const p_support_kg = getVal('support_material_cost_kg'); // $/kg
                const p_hourlywage = getVal('hourly_wage'); // $/hour
                const t_prep_min = getVal('prep_slicing_time'); // minutes/build plate
                const t_manual_min = getVal('manual_labor_time'); // minutes/build plate

                // Densities
                // For nozzle wear calculations, use first material's density as representative
                const d_model = getDensity('material_1_type', 'material_1_density_custom'); // g/cm³
                const d_support = getDensity('support_material_type', 'support_material_density_custom'); // g/cm³

                // Machine Operation
                const p_printer = getVal('printer_cost');
                const t_printer_lifespan = getVal('printer_lifespan_hr');
                const p_maintenance_hr = getVal('maintenance_cost_hr');
                const E_machine_w = getVal('machine_power_w'); // watts
                const p_electricity_kwh = getVal('electricity_cost_kwh'); // $/kWh

                // Tooling
                const p_bed = getVal('build_plate_cost');
                const t_bed_lifespan = getVal('build_plate_lifespan_hr');
                const p_model_tip = getVal('model_nozzle_cost');
                const m_model_tip_lifespan_kg = getVal('model_nozzle_lifespan_kg'); // kg
                const p_support_tip = getVal('support_nozzle_cost');
                const m_support_tip_lifespan_kg = getVal('support_nozzle_lifespan_kg'); // kg

                // Finishing & Post-Processing
                const t_finishing_min_part = getVal('finishing_labor_time_part'); // minutes/part
                const p_finishing_materials = getVal('finishing_materials_cost'); // $/build plate
                const p_solvent_liter = getVal('solvent_cost_liter'); // $/Liter
                const t_solving_hr = getVal('solving_time_hr'); // hours
                const E_tank_w = getVal('tank_power_w'); // watts

                // Markup
                const markup_percent = getVal('markup_percent') / 100; // as decimal

                // --- 2. Perform Calculations (based on article) ---

                // --- Helper Calcs: Support Material Volume (V) ---
                // Volume = Mass / Density. V_support in cm³
                // Validation: Ensure density > 0 to avoid division by zero
                const V_support_total = (d_support > 0) ? (m_support_g / d_support) : 0;

                // --- Helper Calcs: Lifespan Conversions ---
                // Convert Nozzle Lifespan from mass (kg) to volume (cm³)
                // 
                // Why convert mass to volume?
                // Nozzle wear is primarily a function of the volume of material extruded through it,
                // not just the mass. Different materials with different densities will have different
                // volumes for the same mass. By converting to volume, we can accurately track nozzle
                // wear regardless of material type.
                //
                // Conversion: kg → g → cm³
                // Step 1: m_model_tip_lifespan_kg * 1000 = grams
                // Step 2: grams / density (g/cm³) = cm³
                // Result: Lifetime_Volume_cm³ = (Lifetime_Mass_kg * 1000) / Density_g/cm³
                //
                // For model materials, use first material's density as representative for nozzle wear
                // Validation: Ensure density > 0 to avoid division by zero
                const V_m_lifespan = (d_model > 0) ? ((m_model_tip_lifespan_kg * 1000) / d_model) : 0;
                const V_s_lifespan = (d_support > 0) ? ((m_support_tip_lifespan_kg * 1000) / d_support) : 0;


                // --- Cost Component 1: Material (C_material) (Eq 1, modified, multi-material) ---
                // Loop through all model materials and sum costs
                const num_model_materials = parseInt(getStr('num_model_materials') || '1');
                let C_material_build_plate = 0;
                let total_model_mass_g = 0;
                let total_model_volume_cm3 = 0;
                const materials = []; // Store material details for quote
                
                // Calculate cost for each model material
                for (let i = 1; i <= num_model_materials; i++) {
                    const mass_g = getVal(`material_${i}_mass_g`);
                    const cost_kg = getVal(`material_${i}_cost_kg`);
                    const material_type = getStr(`material_${i}_type`) || 'PLA';
                    const density = getDensity(`material_${i}_type`, `material_${i}_density_custom`);
                    
                    // Material cost
                    const material_cost = (mass_g / 1000) * cost_kg;
                    C_material_build_plate += material_cost;
                    
                    // Track totals for tooling calculations
                    total_model_mass_g += mass_g;
                    if (density > 0) {
                        total_model_volume_cm3 += (mass_g / density);
                    }
                    
                    // Store for quote display
                    materials.push({
                        name: getMaterialName(`material_${i}_type`),
                        mass_g: mass_g,
                        cost_kg: cost_kg,
                        cost: material_cost
                    });
                }
                
                // Support material (separate, optional)
                const C_support = (m_support_g / 1000) * p_support_kg;
                C_material_build_plate += C_support;
                
                // Add support material to materials array if used
                if (m_support_g > 0) {
                    materials.push({
                        name: getMaterialName('support_material_type') + ' (Support)',
                        mass_g: m_support_g,
                        cost_kg: p_support_kg,
                        cost: C_support
                    });
                }

                // --- Cost Component 2: Labor (C_labor) (Eq 6, v2, expanded) ---
                // Pre-print labor (per plate): slicing, bed prep, removal
                const t_build_plate_labor_min = t_prep_min + t_manual_min;
                
                // Per-part finishing labor: sanding, painting, etc. per part
                const t_part_labor_min = t_finishing_min_part * N_parts;
                
                // Per-plate finishing labor: handling, packing, QC per plate
                const t_finishing_min_plate = getVal('finishing_labor_time_plate'); // minutes/plate
                const t_plate_finishing_labor_min = t_finishing_min_plate;
                
                // Total labor time in hours
                const t_total_labor_hr = (t_build_plate_labor_min + t_part_labor_min + t_plate_finishing_labor_min) / 60;
                const C_labor_build_plate = p_hourlywage * t_total_labor_hr;

                // --- Cost Component 3: Machine Operation (C_machine) (Eq 3 & 4, expanded) ---
                // C_depreciation ($/hr) = Printer Cost / Printer Lifespan
                // Validation: Check printer lifespan > 0 to avoid division by zero
                const C_depreciation_hr = (t_printer_lifespan > 0) ? (p_printer / t_printer_lifespan) : 0;
                // C_power ($/hr) = (Watts / 1000) * $/kWh
                const C_power_hr = (E_machine_w / 1000) * p_electricity_kwh;
                // C_machine_hr = Depreciation + Maintenance + Power
                const C_machine_hr = C_depreciation_hr + p_maintenance_hr + C_power_hr;
                const C_machine_build_plate = C_machine_hr * t_program;

                // --- Cost Component 4: Tooling (C_tooling) (Eq 5, modified, multi-material) ---
                // C_bed = (Bed Cost / Bed Lifespan_hr) * Program_hr
                // Validation: Check lifespan > 0 to avoid division by zero
                const C_bed = (t_bed_lifespan > 0) ? (p_bed / t_bed_lifespan) * t_program : 0;
                
                // C_nozzle = (Nozzle Cost / Nozzle Lifespan_cm³) * Total_Volume_cm³
                // Use aggregated model material volume from all materials
                // Validation: Check V_m_lifespan > 0 to avoid division by zero
                const C_model_tip = (V_m_lifespan > 0) ? (p_model_tip / V_m_lifespan) * total_model_volume_cm3 : 0;
                
                // Check if separate support nozzle is used
                // Validation: Check both cost and lifespan > 0 before division
                const C_support_tip = (p_support_tip > 0 && V_s_lifespan > 0) ?
                    (p_support_tip / V_s_lifespan) * V_support_total : 0;
                
                // If no separate support nozzle, add support volume to model nozzle wear
                // Validation: Check V_m_lifespan > 0 to avoid division by zero
                const C_model_tip_extra_wear = (p_support_tip <= 0 && V_m_lifespan > 0) ?
                    (p_model_tip / V_m_lifespan) * V_support_total : 0;

                const C_tooling_build_plate = C_bed + C_model_tip + C_support_tip + C_model_tip_extra_wear;

                // --- Cost Component 5: Post-Processing (C_postprocess) (Eq 2) ---
                // C_solvent = (p_solvent_liter / 1000 cm³) * V_support_cm³
                const C_solvent = (p_solvent_liter / 1000) * V_support_total;
                // C_tank_power = (Tank_Watts / 1000) * $/kWh * Solving_Time_hr
                const C_tank_power = (E_tank_w / 1000) * p_electricity_kwh * t_solving_hr;
                const C_postprocess_build_plate = C_solvent + C_tank_power + p_finishing_materials;

                // --- 3. Calculate Totals (Eq 7, expanded) ---

                // C_subtotal_build_plate = Sum of all base costs FOR ONE PLATE
                const C_subtotal_build_plate = C_material_build_plate + C_labor_build_plate + C_machine_build_plate + C_tooling_build_plate + C_postprocess_build_plate;

                // C_failure_markup = Cost to account for failures (per plate)
                const C_failure_markup = (failure_rate > 0 && failure_rate < 1) ?
                    (C_subtotal_build_plate / (1 - failure_rate)) - C_subtotal_build_plate : 0;

                // C_total_build_plate = Base cost + Failure markup (per plate)
                const C_total_build_plate = C_subtotal_build_plate + C_failure_markup;

                // C_total_per_part = Total build plate cost / number of parts per plate
                const C_total_per_part = (N_parts > 0) ? (C_total_build_plate / N_parts) : 0;

                // --- Calculate Markup (Percentage or Flat Dollar) ---
                const markupTypeElement = document.querySelector('input[name="markup_type"]:checked');
                const markupType = markupTypeElement ? markupTypeElement.value : 'percent';
                let C_markup_per_part = 0;
                let C_markup_per_plate = 0;
                
                if (markupType === 'percent') {
                    // Percentage markup: applied to cost per part
                    C_markup_per_part = C_total_per_part * markup_percent;
                    C_markup_per_plate = C_markup_per_part * N_parts;
                } else if (markupType === 'flat') {
                    // Flat dollar markup: applied per build plate, then divided by parts
                    const markup_flat = getVal('markup_flat_dollar');
                    C_markup_per_plate = markup_flat;
                    C_markup_per_part = (N_parts > 0) ? (markup_flat / N_parts) : 0;
                }

                // C_final_quote_per_part = Final price per part to charge customer
                const C_final_quote_per_part = C_total_per_part + C_markup_per_part;
                
                // C_final_quote_per_plate = Final price per plate (with markup)
                const C_final_quote_per_plate = C_total_build_plate + C_markup_per_plate;

                // --- BATCH JOB CALCULATIONS (Multiple Plates) ---
                const N_parts_total = N_parts * N_plates; // Total parts across all plates
                const t_program_total = t_program * N_plates; // Total print time for all plates
                const total_mass_g_per_plate = total_model_mass_g + m_support_g; // Mass per plate (all materials)
                const total_mass_g_total = total_mass_g_per_plate * N_plates; // Total mass all plates

                // Total job costs (all plates)
                const C_material_total = C_material_build_plate * N_plates;
                const C_labor_total = C_labor_build_plate * N_plates;
                const C_machine_total = C_machine_build_plate * N_plates;
                const C_tooling_total = C_tooling_build_plate * N_plates;
                const C_postprocess_total = C_postprocess_build_plate * N_plates;
                const C_subtotal_total = C_subtotal_build_plate * N_plates;
                const C_failure_total = C_failure_markup * N_plates;
                const C_total_job_base = C_total_build_plate * N_plates;
                const C_markup_total = C_markup_per_plate * N_plates;
                const C_final_quote_total = C_final_quote_per_plate * N_plates;

                // --- 4. Calculate Quick Metrics ---
                // Validation: Check divisors > 0 to avoid division by zero
                const C_per_hour = (t_program > 0) ? (C_total_build_plate / t_program) : 0;
                const C_per_gram = (total_mass_g_per_plate > 0) ? (C_total_build_plate / total_mass_g_per_plate) : 0;

                // --- 5. Store values for Quote Modal ---
                lastCalculatedCosts = {
                    // Per-part pricing
                    C_final_quote_per_part, C_total_per_part, C_markup_per_part,
                    
                    // Per-plate costs
                    C_total_build_plate, C_material_build_plate, C_labor_build_plate,
                    C_machine_build_plate, C_tooling_build_plate, C_postprocess_build_plate,
                    C_subtotal_build_plate, C_failure_markup, C_final_quote_per_plate,
                    
                    // Total job costs (all plates)
                    C_material_total, C_labor_total, C_machine_total, C_tooling_total, 
                    C_postprocess_total, C_subtotal_total, C_failure_total,
                    C_total_job_base, C_markup_total, C_final_quote_total,
                    
                    // Quantities and metrics
                    N_parts, N_plates, N_parts_total, t_program, t_program_total,
                    total_mass_g_per_plate, total_mass_g_total, C_per_hour, C_per_gram,
                    
                    // Material details for quote
                    materials: materials,
                    num_model_materials: num_model_materials
                };

                // --- 6. Update UI ---

                // Main Display - show per part price
                document.getElementById('summary_final_quote').textContent = formatCurrency(C_final_quote_per_part);
                document.getElementById('summary_total_cost_per_part').textContent = `(${formatCurrency(C_total_per_part)} base cost + ${formatCurrency(C_markup_per_part)} markup)`;

                // Program/Part Summary - show batch info
                document.getElementById('summary_parts_count_1').textContent = N_parts_total;
                document.getElementById('summary_total_build_plate_cost').textContent = formatCurrency(C_final_quote_total);
                document.getElementById('summary_base_cost_per_part').textContent = formatCurrency(C_total_per_part);

                // Cost Breakdown - show PER PLATE costs (as these are more useful for understanding the breakdown)
                document.getElementById('summary_material_cost').textContent = formatCurrency(C_material_build_plate);
                document.getElementById('summary_labor_cost').textContent = formatCurrency(C_labor_build_plate);
                document.getElementById('summary_machine_cost').textContent = formatCurrency(C_machine_build_plate);
                document.getElementById('summary_tooling_cost').textContent = formatCurrency(C_tooling_build_plate);
                document.getElementById('summary_post_processing_cost').textContent = formatCurrency(C_postprocess_build_plate);

                document.getElementById('summary_subtotal_cost').textContent = formatCurrency(C_subtotal_build_plate);
                document.getElementById('summary_failure_rate').textContent = formatNum(failure_rate * 100, 0);
                document.getElementById('summary_failure_cost').textContent = formatCurrency(C_failure_markup);
                document.getElementById('summary_total_cost').textContent = formatCurrency(C_total_build_plate);

                // Quick Metrics - show per plate metrics
                document.getElementById('summary_total_time').textContent = `${formatNum(t_program, 2)} hr`;
                document.getElementById('summary_total_mass').textContent = `${formatNum(total_mass_g_per_plate, 1)} g`;
                document.getElementById('summary_cost_per_hour').textContent = formatCurrency(C_per_hour);
                document.getElementById('summary_cost_per_gram').textContent = formatCurrency(C_per_gram);

                // Update Pie Chart
                updatePieChart([
                    { id: 'legend_material', value: C_material_build_plate, color: '#3b82f6' }, // Blue
                    { id: 'legend_labor', value: C_labor_build_plate, color: '#10b981' }, // Green
                    { id: 'legend_machine', value: C_machine_build_plate, color: '#f59e0b' }, // Amber
                    { id: 'legend_tooling', value: C_tooling_build_plate, color: '#ef4444' }, // Red
                    { id: 'legend_finishing', value: C_postprocess_build_plate, color: '#8b5cf6' } // Violet
                ]);
            }

            /**
             * Updates the CSS conic-gradient pie chart and its legend.
             * @param {Array<Object>} costs - Array of cost objects {id, value, color}
             */
            function updatePieChart(costs) {
                const total = costs.reduce((acc, cost) => acc + cost.value, 0);
                let gradientString = '';
                let currentPercent = 0;

                for (const cost of costs) {
                    const percent = (total > 0) ? (cost.value / total) * 100 : 0;
                    const percentStr = `(${formatNum(percent, 0)}%)`;

                    // Update legend
                    const legendEl = document.getElementById(cost.id);
                    if (legendEl) {
                        legendEl.textContent = `${formatCurrency(cost.value)} ${percentStr}`;
                    }

                    // Build gradient string
                    if (percent > 0) {
                        const nextPercent = currentPercent + percent;
                        gradientString += `${cost.color} ${currentPercent}% ${nextPercent}%, `;
                        currentPercent = nextPercent;
                    }
                }

                // Set chart background
                if (pieChartEl) {
                    if (total > 0) {
                        pieChartEl.style.backgroundImage = `conic-gradient(${gradientString.slice(0, -2)})`;
                    } else {
                        // Default to gray if no costs
                        pieChartEl.style.backgroundImage = `conic-gradient(#e5e7eb 0% 100%)`;
                    }
                }
            }

            // --- PROFILE SAVE/LOAD ---

            function saveProfile() {
                console.log('Save Profile button clicked');
                console.log('Storage available:', storageAvailable);
                try {
                    const profile = {};
                    // Save ALL input and select elements
                    allInputs.forEach(input => {
                        if (input.id) {
                            profile[input.id] = input.value;
                        }
                    });
                    console.log('Profile data:', profile);
                    localStorage.setItem('fdmCalculatorProfile', JSON.stringify(profile));
                    console.log('Profile saved to localStorage');
                    showMessage('All settings saved successfully!', 'success');
                } catch (error) {
                    console.error("Failed to save profile:", error);
                    if (!storageAvailable) {
                        showMessage('Error: Browser storage is not available or blocked.', 'error');
                    } else {
                        showMessage('Error saving profile. Storage may be full or blocked by browser settings.', 'error');
                    }
                }
            }

            function loadProfile() {
                console.log('Load Profile button clicked');
                console.log('Storage available:', storageAvailable);
                try {
                    const profileString = localStorage.getItem('fdmCalculatorProfile');
                    console.log('Profile string from localStorage:', profileString);
                    if (!profileString) {
                        showMessage('No saved profile found.', 'warn');
                        return;
                    }
                    const profile = JSON.parse(profileString);
                    console.log('Loaded profile data:', profile);
                    
                    // Load ALL saved values
                    for (const id in profile) {
                        if (profile.hasOwnProperty(id)) {
                            const el = document.getElementById(id);
                            if (el) {
                                el.value = profile[id];
                                // Trigger input event to update UI
                                el.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }
                    }

                    // Trigger updates for custom fields and info boxes
                    toggleCustomDensity('model_material_type', 'model_material_density_custom_wrapper');
                    toggleCustomDensity('support_material_type', 'support_material_density_custom_wrapper');
                    updateMaterialInfo('model_material_type', 'model_material_info');
                    updateMaterialInfo('support_material_type', 'support_material_info');

                    // Recalculate
                    calculateCost();
                    showMessage('All settings loaded successfully!', 'success');
                } catch (error) {
                    console.error("Failed to load profile:", error);
                    if (!storageAvailable) {
                        showMessage('Error: Browser storage is not available or blocked.', 'error');
                    } else {
                        showMessage('Error loading profile. Data may be corrupt or blocked by browser settings.', 'error');
                    }
                }
            }

            // --- CUSTOM MATERIAL MANAGER ---

            function getCustomMaterials() {
                try {
                    const materialsString = localStorage.getItem(CUSTOM_MATERIALS_KEY);
                    return materialsString ? JSON.parse(materialsString) : [];
                } catch (e) {
                    console.error("Failed to get custom materials:", e);
                    return [];
                }
            }

            function saveCustomMaterials(materials) {
                try {
                    localStorage.setItem(CUSTOM_MATERIALS_KEY, JSON.stringify(materials));
                } catch (e) {
                    console.error("Failed to save custom materials:", e);
                    showMessage('Error saving custom material. Storage may be full or blocked.', 'error');
                }
            }

            function saveNewCustomMaterial() {
                const name = getStr('custom_material_name');
                const density = getVal('custom_material_density');

                if (!name || density <= 0) {
                    showMessage('Please enter a valid material name and density.', 'error');
                    return;
                }

                const newMaterial = { name, density };
                const materials = getCustomMaterials();

                // Check for duplicates
                if (materials.some(m => m.name.toLowerCase() === name.toLowerCase())) {
                    showMessage('A material with this name already exists.', 'error');
                    return;
                }

                materials.push(newMaterial);
                saveCustomMaterials(materials);
                populateCustomMaterialDropdowns();
                renderCustomMaterialList();

                // Clear inputs
                document.getElementById('custom_material_name').value = '';
                document.getElementById('custom_material_density').value = '';

                showMessage(`Material "${name}" saved!`, 'success');
            }

            function populateCustomMaterialDropdowns() {
                const materials = getCustomMaterials();
                const modelGroup = document.getElementById('model_material_custom_group');
                const supportGroup = document.getElementById('support_material_custom_group');

                if (!modelGroup || !supportGroup) return;

                // Clear existing options
                modelGroup.innerHTML = '';
                supportGroup.innerHTML = '';

                materials.forEach(material => {
                    const value = `${material.density}_${material.name}`;
                    const text = `${material.name} (${material.density} g/cm³)`;

                    const modelOption = new Option(text, value);
                    modelGroup.appendChild(modelOption);

                    const supportOption = new Option(text, value);
                    supportGroup.appendChild(supportOption);
                });
            }

            function renderCustomMaterialList() {
                const materials = getCustomMaterials();
                const listEl = document.getElementById('custom_material_list');
                if (!listEl) return;

                if (materials.length === 0) {
                    listEl.innerHTML = '<p>No custom materials saved.</p>';
                    return;
                }

                listEl.innerHTML = '<strong class="block mb-1">Saved Materials:</strong>';
                materials.forEach((material, index) => {
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                    el.innerHTML = `
                        <span>${material.name} (${material.density} g/cm³)</span>
                        <button data-index="${index}" class="remove-material-btn text-red-500 hover:text-red-700 text-xs font-medium">Remove</button>
                    `;
                    listEl.appendChild(el);
                });
            }

            function removeCustomMaterial(e) {
                if (!e.target.classList.contains('remove-material-btn')) return;

                const index = parseInt(e.target.getAttribute('data-index'), 10);
                let materials = getCustomMaterials();
                const removed = materials.splice(index, 1);
                saveCustomMaterials(materials);
                populateCustomMaterialDropdowns();
                renderCustomMaterialList();

                if (removed.length > 0) {
                    showMessage(`Material "${removed[0].name}" removed.`, 'success');
                }
            }

            // --- QUOTE MODAL ---

            function openQuoteModal() {
                // Populate modal with data from last calculation
                const customer = getStr('quote_customer') || "N/A";
                const partName = getStr('quote_part_name') || "N/A";
                
                // Build materials list
                let materialText = '';
                if (lastCalculatedCosts.materials && lastCalculatedCosts.materials.length > 0) {
                    materialText = lastCalculatedCosts.materials.map(mat => {
                        return `${mat.name}: ${formatNum(mat.mass_g, 1)}g @ ${formatCurrency(mat.cost_kg)}/kg`;
                    }).join('<br>');
                } else {
                    materialText = 'N/A';
                }

                document.getElementById('quote_date').textContent = new Date().toLocaleDateString();
                document.getElementById('quote_customer_name').textContent = customer;
                document.getElementById('quote_part_name_val').textContent = partName;
                document.getElementById('quote_material_val').innerHTML = materialText;
                
                // Show per-plate time and total job time if multiple plates
                const timeText = lastCalculatedCosts.N_plates > 1 
                    ? `${formatNum(lastCalculatedCosts.t_program, 2)} hr/plate (${formatNum(lastCalculatedCosts.t_program_total, 2)} hr total)`
                    : `${formatNum(lastCalculatedCosts.t_program, 2)} hr`;
                document.getElementById('quote_time_val').textContent = timeText;

                document.getElementById('quote_item_name').textContent = partName;
                document.getElementById('quote_quantity_val').textContent = lastCalculatedCosts.N_parts_total;
                document.getElementById('quote_price_per_val').textContent = formatCurrency(lastCalculatedCosts.C_final_quote_per_part);

                const total = lastCalculatedCosts.C_final_quote_total;
                document.getElementById('quote_total_val').textContent = formatCurrency(total);
                document.getElementById('quote_grand_total_val').textContent = formatCurrency(total);

                if (quoteModal) quoteModal.classList.remove('hidden');
            }

            function closeQuoteModal() {
                if (quoteModal) quoteModal.classList.add('hidden');
            }

            function printQuote() {
                console.log('Print Quote button clicked');
                
                // Get the printable content (the scrollable div with actual content)
                const printContent = document.querySelector('#quote-modal-content .overflow-y-auto');
                
                if (!printContent) {
                    console.error('Print content not found');
                    showMessage('Error: Could not find content to print', 'error');
                    return;
                }

                // Create a new window for printing
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                
                if (!printWindow) {
                    console.error('Could not open print window');
                    showMessage('Error: Popup blocked. Please allow popups for this site.', 'error');
                    return;
                }

                // Build the HTML for the print window
                const printHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Print Job Quote</title>
                        <style>
                            @page {
                                size: letter;
                                margin: 0.5in;
                            }
                            body {
                                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                                line-height: 1.5;
                                color: #1f2937;
                                background: white;
                                margin: 0;
                                padding: 20px;
                            }
                            h3, h4 {
                                color: #1f2937;
                                margin-top: 1.5rem;
                                margin-bottom: 0.5rem;
                            }
                            h3 {
                                font-size: 1.5rem;
                                font-weight: bold;
                            }
                            h4 {
                                font-size: 1.125rem;
                                font-weight: 600;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 1.5rem;
                                border: 1px solid #e5e7eb;
                            }
                            th, td {
                                padding: 0.75rem;
                                text-align: left;
                                border: 1px solid #e5e7eb;
                            }
                            th {
                                background-color: #f9fafb;
                                font-weight: 600;
                                font-size: 0.75rem;
                                text-transform: uppercase;
                                color: #6b7280;
                            }
                            thead th {
                                background-color: #f9fafb;
                            }
                            tfoot td {
                                background-color: #f9fafb;
                                font-weight: bold;
                            }
                            .text-right {
                                text-align: right;
                            }
                            textarea {
                                width: 100%;
                                padding: 0.5rem;
                                border: 1px solid #e5e7eb;
                                border-radius: 0.375rem;
                                font-family: inherit;
                                min-height: 100px;
                            }
                            p {
                                margin: 0.5rem 0;
                            }
                            .header-section {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 1.5rem;
                            }
                            .to-section {
                                background-color: #f9fafb;
                                padding: 1rem;
                                border-radius: 0.5rem;
                                margin-bottom: 1.5rem;
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent.innerHTML}
                    </body>
                    </html>
                `;

                // Write content to the new window
                printWindow.document.open();
                printWindow.document.write(printHTML);
                printWindow.document.close();

                // Wait for content to load, then print
                printWindow.onload = function() {
                    console.log('Print window loaded');
                    setTimeout(() => {
                        printWindow.print();
                        // Close the window after printing
                        setTimeout(() => {
                            printWindow.close();
                        }, 500);
                    }, 250);
                };
            }


            // --- EVENT LISTENERS ---

            // Initialize material groups on page load
            generateMaterialGroups(1); // Start with 1 material
            
            // Add listener for number of materials selector
            const numMaterialsSelect = document.getElementById('num_model_materials');
            if (numMaterialsSelect) {
                numMaterialsSelect.addEventListener('change', (e) => {
                    const numMaterials = parseInt(e.target.value);
                    generateMaterialGroups(numMaterials);
                    calculateCost();
                });
            }

            // Add 'input' event listener to all inputs to recalculate
            allInputs.forEach(input => {
                input.addEventListener('input', calculateCost);
            });

            // Add listeners for custom density toggles (support material only now)
            document.getElementById('support_material_type')?.addEventListener('input', () => {
                toggleCustomDensity('support_material_type', 'support_material_density_custom_wrapper');
                updateMaterialInfo('support_material_type', 'support_material_info');
            });

            // Add listener for currency selector
            const currencySelector = document.getElementById('currency_selector');
            if (currencySelector) {
                currencySelector.addEventListener('change', calculateCost);
            }

            // Add listeners for markup type radio buttons
            const markupTypeRadios = document.querySelectorAll('input[name="markup_type"]');
            markupTypeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    toggleMarkupType();
                    calculateCost();
                });
            });

            // Add listeners for Save/Load buttons
            console.log('saveProfileButton element:', saveProfileButton);
            console.log('loadProfileButton element:', loadProfileButton);
            if (saveProfileButton) {
                saveProfileButton.addEventListener('click', saveProfile);
                console.log('Save profile event listener attached');
            } else {
                console.error('saveProfileButton not found!');
            }
            if (loadProfileButton) {
                loadProfileButton.addEventListener('click', loadProfile);
                console.log('Load profile event listener attached');
            } else {
                console.error('loadProfileButton not found!');
            }

            // Custom Material Listeners
            if (saveMaterialButton) saveMaterialButton.addEventListener('click', saveNewCustomMaterial);
            const materialListEl = document.getElementById('custom_material_list');
            if (materialListEl) materialListEl.addEventListener('click', removeCustomMaterial);

            // Quote Modal Listeners
            if (generateQuoteBtn) generateQuoteBtn.addEventListener('click', openQuoteModal);
            if (quoteModalCloseBtn) quoteModalCloseBtn.addEventListener('click', closeQuoteModal);
            if (quoteModalBackdrop) quoteModalBackdrop.addEventListener('click', closeQuoteModal);
            if (printQuoteBtn) printQuoteBtn.addEventListener('click', printQuote);
            
            // Add listener for the top print button
            const printQuoteBtnTop = document.getElementById('quote-modal-print-top');
            if (printQuoteBtnTop) printQuoteBtnTop.addEventListener('click', printQuote);

            // --- INITIALIZATION ---

            // Load custom materials into dropdowns
            populateCustomMaterialDropdowns();
            renderCustomMaterialList();

            // Run initial calculation on page load
            calculateCost();

            // Set initial state for info boxes
            updateMaterialInfo('model_material_type', 'model_material_info');
            updateMaterialInfo('support_material_type', 'support_material_info');

        }); // Close DOMContentLoaded
    </script>
</body>

</html>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4c42dc3209f6e4052e69c9952bc249f2">2 - 3D Print Shinkage Calculator</h1>
    <div class="lead">Calculate the shrinkage of 3D prints with FDM technology.</div>
	
<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Shrinkage Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Use a monospace font for results */
        .font-mono {
            font-family: 'Mono', monospace;
        }

        /* Custom styles for copy button feedback */
        .copy-btn-feedback::after {
            content: 'Copied!';
            position: absolute;
            top: -1.75rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10B981;
            /* green-500 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .copy-btn-feedback.show-feedback::after {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 h-full flex items-center justify-center py-12 px-4">

    <div class="max-w-4xl w-full bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-8">

        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-white">Filament Shrinkage Calculator</h1>
            <p class="mt-2 text-lg text-gray-400">For OrcaSlicer & BambuSlicer (using Calibration Cross)</p>
        </div>

        <!-- Instructions Section -->
        <div>
            <h2 class="text-xl font-semibold text-gray-200 mb-3">Instructions</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-300 bg-gray-900 p-4 rounded-lg">
                <li>Load the calibration model: <a href="./Multi-Measurement-Calibration-Cross.stl" target="_blank"
                        rel="noopener noreferrer"
                        class="text-blue-400 hover:text-blue-300 underline">Multi-Measurement-Calibration-Cross.stl</a>.
                </li>
                <li>Print the model with <strong>100% shrinkage</strong> and <strong>0mm XY Compensation</strong>.</li>
                <li>Let the print cool completely, then measure it carefully with calipers.</li>
                <li>Enter your 8 measured values below and click "Calculate".</li>
            </ol>
        </div>

        <!-- Calculator Form -->
        <div id="calculator-form" class="space-y-6">

            <!-- Error Message Area -->
            <div id="error-message" class="hidden bg-red-800 border border-red-700 text-red-100 px-4 py-3 rounded-lg"
                role="alert">
                <p>Please enter valid measured values for all 8 fields.</p>
            </div>

            <!-- Section 1: Outer Dimensions (for Shrinkage) -->
            <fieldset class="bg-gray-900/50 p-6 rounded-lg">
                <legend class="text-lg font-semibold text-white px-2">1. Outer Dimensions (for Shrinkage)</legend>
                <div class="md:grid md:grid-cols-2 md:gap-8 items-center">
                    <!-- Input fields for outer dimensions -->
                    <div class="space-y-4">
                        <p class="text-sm text-gray-400 mb-2">Designed values are 80mm (A, B) and 20mm (C, D).</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="measured-a" class="block text-sm font-medium text-gray-300 mb-1">Measured A
                                    (mm)</label>
                                <input type="number" id="measured-a" placeholder="e.g., 79.85" step="0.01"
                                    class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="measured-b" class="block text-sm font-medium text-gray-300 mb-1">Measured B
                                    (mm)</label>
                                <input type="number" id="measured-b" placeholder="e.g., 79.88" step="0.01"
                                    class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="measured-c" class="block text-sm font-medium text-gray-300 mb-1">Measured C
                                    (mm)</label>
                                <input type="number" id="measured-c" placeholder="e.g., 19.90" step="0.01"
                                    class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="measured-d" class="block text-sm font-medium text-gray-300 mb-1">Measured D
                                    (mm)</label>
                                <input type="number" id="measured-d" placeholder="e.g., 19.92" step="0.01"
                                    class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    <!-- SVG Diagram for Outer Dimensions -->
                    <div class="mt-6 md:mt-0 flex items-center justify-center">
                        <svg viewBox="-10 -15 130 135" class="w-80 h-auto text-gray-400" stroke="currentColor" fill="none"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <title>Top-down diagram of outer cross measurements</title>
                            <!-- Cross Shape -->
                            <path d="M 40 10 H 60 V 40 H 90 V 60 H 60 V 90 H 40 V 60 H 10 V 40 H 40 Z"
                                fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.3)" stroke-width="1" />

                            <!-- A Measurement (Horizontal) -->
                            <path d="M 10 98 H 90" stroke="#60A5FA" stroke-width="1.5" />
                            <path d="M 10 98 l 5 -3 M 10 98 l 5 3 M 90 98 l -5 -3 M 90 98 l -5 3" stroke="#60A5FA"
                                stroke-width="1.5" />
                            <path d="M 10 90 v 8" stroke="#60A5FA" stroke-dasharray="2,2" stroke-width="1" />
                            <path d="M 90 90 v 8" stroke="#60A5FA" stroke-dasharray="2,2" stroke-width="1" />
                            <!-- Background for text -->
                            <rect x="30" y="105" width="40" height="13" rx="2" fill="rgba(17, 24, 39, 0.95)" />
                            <text x="50" y="113.5" fill="#60A5FA" font-size="8" font-weight="100" font-family="Inter, sans-serif"
                                text-anchor="middle">A (80)</text>

                            <!-- B Measurement (Vertical) -->
                            <path d="M 98 10 V 90" stroke="#34D399" stroke-width="1.5" />
                            <path d="M 98 10 l -3 5 M 98 10 l 3 5 M 98 90 l -3 -5 M 98 90 l 3 -5" stroke="#34D399"
                                stroke-width="1.5" />
                            <path d="M 90 10 h 8" stroke="#34D399" stroke-dasharray="2,2" stroke-width="1" />
                            <path d="M 90 90 h 8" stroke="#34D399" stroke-dasharray="2,2" stroke-width="1" />
                            <!-- Background for text -->
                            <rect x="105" y="40" width="13" height="40" rx="2" fill="rgba(17, 24, 39, 0.95)" />
                            <text x="111.5" y="63" fill="#34D399" font-size="8" font-weight="100" font-family="Inter, sans-serif"
                                text-anchor="middle" transform="rotate(90 111.5 63)">B (80)</text>

                            <!-- C Measurement (Horizontal Arm) -->
                            <path d="M 40 5 H 60" stroke="#FBBF24" stroke-width="1.5" />
                            <path d="M 40 5 l 5 -3 M 40 5 l 5 3 M 60 5 l -5 -3 M 60 5 l -5 3"
                                stroke="#FBBF24" stroke-width="1.5" />
                            <path d="M 40 10 v -5" stroke="#FBBF24" stroke-dasharray="2,2" stroke-width="1" />
                            <path d="M 60 10 v -5" stroke="#FBBF24" stroke-dasharray="2,2" stroke-width="1" />
                            <!-- Background for text -->
                            <rect x="35" y="-13" width="30" height="13" rx="2" fill="rgba(17, 24, 39, 0.95)" />
                            <text x="50" y="-4.5" fill="#FBBF24" font-size="8" font-weight="100" font-family="Inter, sans-serif"
                                text-anchor="middle">C (20)</text>

                            <!-- D Measurement (Vertical Arm) -->
                            <path d="M 5 40 V 60" stroke="#F87171" stroke-width="1.5" />
                            <path d="M 5 40 l -3 5 M 5 40 l 3 5 M 5 60 l -3 -5 M 5 60 l 3 -5" stroke="#F87171"
                                stroke-width="1.5" />
                            <path d="M 10 40 h -5" stroke="#F87171" stroke-dasharray="2,2" stroke-width="1" />
                            <path d="M 10 60 h -5" stroke="#F87171" stroke-dasharray="2,2" stroke-width="1" />
                            <!-- Background for text -->
                            <rect x="-10" y="42" width="13" height="30" rx="2" fill="rgba(17, 24, 39, 0.95)" />
                            <text x="-3.5" y="59.5" fill="#F87171" font-size="8" font-weight="100" font-family="Inter, sans-serif"
                                text-anchor="middle" transform="rotate(-90 -3.5 59.5)">D (20)</text>
                        </svg>
                    </div>
                </div>
            </fieldset>

            <!-- Section 2: Inner Dimensions (for Hole Compensation) -->
            <fieldset class="bg-gray-900/50 p-6 rounded-lg">
                <legend class="text-lg font-semibold text-white px-2">2. Inner Dimensions (for Hole Comp.)</legend>
                <div class="md:grid md:grid-cols-2 md:gap-8 items-center">
                    <!-- Input fields for inner dimensions -->
                    <div class="space-y-4">
                        <div>
                            <label for="designed-hole" class="block text-sm font-medium text-gray-300 mb-1">Designed
                                Hole (mm)</label>
                            <input type="number" id="designed-hole" value="10" readonly
                                class="w-full bg-gray-700 border-gray-600 text-gray-400 rounded-lg p-3">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="measured-e" class="block text-sm font-medium text-gray-300 mb-1">Measured E
                                    (mm)</label>
                                <input type="number" id="measured-e" placeholder="e.g., 9.80" step="0.01"
                                    class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="measured-f" class="block text-sm font-medium text-gray-300 mb-1">Measured F
                                    (mm)</label>
                                <input type="number" id="measured-f" placeholder="e.g., 9.82" step="0.01"
                                    class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="measured-g" class="block text-sm font-medium text-gray-300 mb-1">Measured G
                                    (mm)</label>
                                <input type="number" id="measured-g" placeholder="e.g., 9.81" step="0.01"
                                    class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="measured-h" class="block text-sm font-medium text-gray-300 mb-1">Measured H
                                    (mm)</label>
                                <input type="number" id="measured-h" placeholder="e.g., 9.79" step="0.01"
                                    class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    <!-- SVG Diagram for Inner Dimensions -->
                    <div class="mt-6 md:mt-0 flex items-center justify-center">
                        <svg viewBox="-5 -15 110 130" class="w-80 h-auto text-gray-400" stroke="currentColor" fill="none"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <title>Top-down diagram of inner hole measurements</title>
                            <!-- Cross Shape -->
                            <path d="M 40 10 H 60 V 40 H 90 V 60 H 60 V 90 H 40 V 60 H 10 V 40 H 40 Z"
                                fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.3)" stroke-width="1" />

                            <!-- Holes -->
                            <circle cx="75" cy="50" r="7" fill="rgba(0,0,0,0.4)" stroke="rgba(255,255,255,0.2)" stroke-width="0.5" />
                            <circle cx="25" cy="50" r="7" fill="rgba(0,0,0,0.4)" stroke="rgba(255,255,255,0.2)" stroke-width="0.5" />
                            <circle cx="50" cy="25" r="7" fill="rgba(0,0,0,0.4)" stroke="rgba(255,255,255,0.2)" stroke-width="0.5" />
                            <circle cx="50" cy="75" r="7" fill="rgba(0,0,0,0.4)" stroke="rgba(255,255,255,0.2)" stroke-width="0.5" />

                            <!-- E Measurement -->
                            <path d="M 68 50 H 82" stroke="#FBBF24" stroke-width="1.5" />
                            <path d="M 68 50 l 3 -2 M 68 50 l 3 2 M 82 50 l -3 -2 M 82 50 l -3 2" stroke="#FBBF24" stroke-width="1.5" />
                            <!-- Background for text -->
                            <rect x="68" y="58" width="30" height="13" rx="2" fill="rgba(17, 24, 39, 0.95)" />
                            <text x="83" y="66.5" fill="#FBBF24" font-size="8" font-weight="100" font-family="Inter, sans-serif"
                                text-anchor="middle">E (10)</text>

                            <!-- F Measurement -->
                            <path d="M 18 50 H 32" stroke="#FBBF24" stroke-width="1.5" />
                            <path d="M 18 50 l 3 -2 M 18 50 l 3 2 M 32 50 l -3 -2 M 32 50 l -3 2" stroke="#FBBF24" stroke-width="1.5" />
                            <!-- Background for text -->
                            <rect x="2" y="58" width="30" height="13" rx="2" fill="rgba(17, 24, 39, 0.95)" />
                            <text x="17" y="66.5" fill="#FBBF24" font-size="8" font-weight="100" font-family="Inter, sans-serif"
                                text-anchor="middle">F (10)</text>

                            <!-- G Measurement -->
                            <path d="M 50 18 V 32" stroke="#FBBF24" stroke-width="1.5" />
                            <path d="M 50 18 l -2 3 M 50 18 l 2 3 M 50 32 l -2 -3 M 50 32 l 2 -3" stroke="#FBBF24" stroke-width="1.5" />
                            <!-- Background for text -->
                            <rect x="35" y="-13" width="30" height="13" rx="2" fill="rgba(17, 24, 39, 0.95)" />
                            <text x="50" y="-4.5" fill="#FBBF24" font-size="8" font-weight="100" font-family="Inter, sans-serif"
                                text-anchor="middle">G (10)</text>

                            <!-- H Measurement -->
                            <path d="M 50 68 V 82" stroke="#FBBF24" stroke-width="1.5" />
                            <path d="M 50 68 l -2 3 M 50 68 l 2 3 M 50 82 l -2 -3 M 50 82 l 2 -3" stroke="#FBBF24" stroke-width="1.5" />
                            <!-- Background for text -->
                            <rect x="35" y="100" width="30" height="13" rx="2" fill="rgba(17, 24, 39, 0.95)" />
                            <text x="50" y="108.5" fill="#FBBF24" font-size="8" font-weight="100" font-family="Inter, sans-serif"
                                text-anchor="middle">H (10)</text>
                        </svg>
                    </div>
                </div>
            </fieldset>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button id="calculate-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 ease-in-out shadow-md">
                    Calculate
                </button>
                <button id="clear-btn"
                    class="w-1/3 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition duration-200 ease-in-out">
                    Clear
                </button>
            </div>
        </div>

        <!-- Results Section (Initially Hidden) -->
        <div id="results-section" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-center text-white">Your OrcaSlicer Values</h2>

            <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 space-y-6">
                <!-- Result 1: Shrinkage -->
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Shrinkage</label>
                    <div class="flex items-center">
                        <input id="result-shrinkage" type="text" readonly
                            class="flex-grow bg-gray-800 text-green-400 text-3xl font-mono p-3 rounded-l-lg border-y border-l border-gray-600 focus:outline-none">
                        <button id="copy-shrinkage-btn" data-clipboard-target="#result-shrinkage"
                            class="copy-btn relative bg-gray-600 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-r-lg"
                            style="padding-top: 1.125rem; padding-bottom: 1.125rem;">
                            Copy
                        </button>
                    </div>
                </div>

                <!-- Result 2: X-Y Contour Compensation -->
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">X-Y Contour Compensation</label>
                    <div class="flex items-center">
                        <input id="result-hole-comp" type="text" readonly
                            class="flex-grow bg-gray-800 text-green-400 text-3xl font-mono p-3 rounded-l-lg border-y border-l border-gray-600 focus:outline-none">
                        <button id="copy-hole-comp-btn" data-clipboard-target="#result-hole-comp"
                            class="copy-btn relative bg-gray-600 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-r-lg"
                            style="padding-top: 1.125rem; padding-bottom: 1.125rem;">
                            Copy
                        </button>
                    </div>
                </div>
            </div>

            <!-- Explanation Section -->
            <div class="bg-gray-900/50 p-6 rounded-lg">
                <h3 class="text-lg font-semibold text-white mb-3">Where to put these values in OrcaSlicer:</h3>
                <p class="text-gray-300 mb-4">Go to: <code
                        class="bg-gray-700 px-2 py-1 rounded-md text-sm">Filament Settings</code> → <code
                        class="bg-gray-700 px-2 py-1 rounded-md text-sm">Filament</code> tab</p>
                <ul class="list-disc list-inside space-y-3 text-gray-300">
                    <li>Paste the <strong class="text-white">Shrinkage</strong> value into the "Shrinkage" field.</li>
                    <li>Paste the <strong class="text-white">X-Y Contour Compensation</strong> value into the "X-Y
                        contour compensation" field (under the Compensation section).</li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get DOM elements
            const calculateBtn = document.getElementById('calculate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const errorMessage = document.getElementById('error-message');
            const resultsSection = document.getElementById('results-section');

            // Input fields
            const measuredAEl = document.getElementById('measured-a');
            const measuredBEl = document.getElementById('measured-b');
            const measuredCEl = document.getElementById('measured-c');
            const measuredDEl = document.getElementById('measured-d');

            const designedHoleEl = document.getElementById('designed-hole');
            const measuredEEl = document.getElementById('measured-e');
            const measuredFEl = document.getElementById('measured-f');
            const measuredGEl = document.getElementById('measured-g');
            const measuredHEl = document.getElementById('measured-h');

            // Result fields
            const resultShrinkageEl = document.getElementById('result-shrinkage');
            const resultHoleCompEl = document.getElementById('result-hole-comp');

            // Copy buttons
            const copyShrinkageBtn = document.getElementById('copy-shrinkage-btn');
            const copyHoleCompBtn = document.getElementById('copy-hole-comp-btn');

            <!-- Calculate button logic -->
            calculateBtn.addEventListener('click', () => {
                // Read and parse values
                const measuredA = parseFloat(measuredAEl.value);
                const measuredB = parseFloat(measuredBEl.value);
                const measuredC = parseFloat(measuredCEl.value);
                const measuredD = parseFloat(measuredDEl.value);

                const designedHole = parseFloat(designedHoleEl.value);
                const measuredE = parseFloat(measuredEEl.value);
                const measuredF = parseFloat(measuredFEl.value);
                const measuredG = parseFloat(measuredGEl.value);
                const measuredH = parseFloat(measuredHEl.value);

                // Validation
                if (isNaN(measuredA) || isNaN(measuredB) || isNaN(measuredC) || isNaN(measuredD) ||
                    isNaN(measuredE) || isNaN(measuredF) || isNaN(measuredG) || isNaN(measuredH) ||
                    measuredA <= 0 || measuredB <= 0 || measuredC <= 0 || measuredD <= 0 ||
                    measuredE <= 0 || measuredF <= 0 || measuredG <= 0 || measuredH <= 0) {
                    errorMessage.classList.remove('hidden');
                    resultsSection.classList.add('hidden');
                    return;
                }

                // Hide error message if valid
                errorMessage.classList.add('hidden');

                // --- Calculations ---

                // 1. Shrinkage Calculation
                // (Total Measured / Total Designed) * 100
                // Total Designed = 80 + 80 + 20 + 20 = 200
                const totalDesigned = 200.0;
                const totalMeasured = measuredA + measuredB + measuredC + measuredD;
                const shrinkagePercent = (totalMeasured / totalDesigned) * 100;

                // 2. Hole Compensation Calculation
                // Average the 4 hole measurements
                const measuredHoleAvg = (measuredE + measuredF + measuredG + measuredH) / 4.0;
                // (Designed - Measured Avg) / 2
                const holeComp = (designedHole - measuredHoleAvg) / 2;

                // --- Display Results ---
                // Format: 99.123%
                resultShrinkageEl.value = `${shrinkagePercent.toFixed(3)}%`;
                // Format: 0.123 mm
                resultHoleCompEl.value = `${holeComp.toFixed(3)} mm`;

                // Show the results section
                resultsSection.classList.remove('hidden');
            });

            // Clear button logic
            clearBtn.addEventListener('click', () => {
                // Clear inputs
                measuredAEl.value = '';
                measuredBEl.value = '';
                measuredCEl.value = '';
                measuredDEl.value = '';
                measuredEEl.value = '';
                measuredFEl.value = '';
                measuredGEl.value = '';
                measuredHEl.value = '';

                // Hide results and errors
                resultsSection.classList.add('hidden');
                errorMessage.classList.add('hidden');
            });

            // --- Copy Button Logic ---
            function copyToClipboard(button, textToCopy) {
                // Create a temporary textarea to hold the text
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = textToCopy.replace(/ mm|%/g, ''); // Copy just the number
                document.body.appendChild(tempTextarea);
                tempTextarea.select();

                try {
                    // Use execCommand for broader compatibility in iFrames
                    document.execCommand('copy');

                    // Show "Copied!" feedback
                    button.classList.add('copy-btn-feedback', 'show-feedback');
                    setTimeout(() => {
                        button.classList.remove('show-feedback');
                        setTimeout(() => button.classList.remove('copy-btn-feedback'), 300);
                    }, 1500);

                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }

                // Remove the temporary textarea
                document.body.removeChild(tempTextarea);
            }

            copyShrinkageBtn.addEventListener('click', () => {
                copyToClipboard(copyShrinkageBtn, resultShrinkageEl.value);
            });

            copyHoleCompBtn.addEventListener('click', () => {
                copyToClipboard(copyHoleCompBtn, resultHoleCompEl.value);
            });
        });
    </script>

</body>

</html>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="YouTube" aria-label="YouTube">
    <a target="_blank" rel="noopener" href="https://www.youtube.com/channel/UCM_8Mv-0S1LnnJpRJLjahaw?sub_confirmation=1" aria-label="YouTube">
      <i class="fa fa-youtube"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/Michael24919360" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Facebook" aria-label="Facebook">
    <a target="_blank" rel="noopener" href="https://www.facebook.com/profile.php?id=100089187391163" aria-label="Facebook">
      <i class="fab facebook"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/minimal3dp" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Minimal 3DP Github" aria-label="Minimal 3DP Github">
    <a target="_blank" rel="noopener" href="https://github.com/minimal3dp/minimal3dp.github.io" aria-label="Minimal 3DP Github">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Developer mailing list" aria-label="Developer mailing list">
    <a target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2021&ndash;2025
    <span class="td-footer__authors">Mike Wilson and Minimal 3DP | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.js"></script>
<script defer src="/js/click-to-copy.js" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
